# KNN模型节假日峰值预测优化说明

## 优化概述

针对 `enknn_model.py` 中节假日预测峰值偏差较大的问题，进行了全面的算法优化，主要包括以下几个方面：

## 主要优化点

### 1. 加权距离度量（Weighted Distance Metric）

**问题**：原始KNN算法使用标准欧氏距离，所有特征权重相同，导致节假日特征的重要性被稀释。

**解决方案**：
- 创建了 `WeightedHolidayKNNRegressor` 类，实现加权距离计算
- 对节假日相关因子（`F_HOLIDAYTYPE`, `F_ISHOLIDAY`, `F_HOLIDAYDAYS`, `F_HOLIDAYTHDAY`, `F_DATEFEATURES`, `F_ISNONGLI`, `F_ISYANGLI`）进行特殊加权
- 默认节假日特征权重为 2.0（可通过配置调整）

**实现细节**：
```python
def _weighted_distance(self, x1, x2):
    """计算加权距离，节假日特征权重更高"""
    weights = np.ones(len(x1))
    weights[self.holiday_factor_indices] = self.holiday_weight
    diff = (x1 - x2) * weights
    return np.sqrt(np.sum(diff ** 2))
```

### 2. 节假日峰值校正机制（Holiday Peak Adjustment）

**问题**：节假日客流峰值往往被低估，因为模型没有充分学习到节假日峰值模式。

**解决方案**：
- 实现 `_calculate_holiday_peak_adjustment()` 方法
- 基于历史节假日数据计算峰值调整系数
- 对节假日预测值进行动态上浮调整

**调整逻辑**：
1. 计算历史节假日平均客流 vs 整体平均客流的倍数
2. 如果节假日峰值明显高于平均值（>10%），应用调整系数
3. 针对特定节假日类型（如春节、国庆等）进行更精细的调整
4. 调整系数上限为 1.5-1.6，避免过度调整

**示例**：
- 如果历史节假日平均客流是整体平均的 1.3 倍
- 则对节假日预测值上浮 30%
- 特定节假日类型（如春节）可能上浮更多

### 3. 训练过程优化

**改进点**：
1. **节假日因子识别**：自动识别节假日相关因子的索引
2. **模型选择**：支持使用加权KNN或标准KNN（可通过配置控制）
3. **评估指标增强**：单独计算节假日数据的预测误差（MSE、MAE）
4. **日志增强**：详细记录节假日预测性能

**配置参数**：
```yaml
train_params:
  n_neighbors_list: [3, 5, 7, 9]  # K值候选列表
  holiday_weight: 2.0              # 节假日特征权重
  use_weighted_holiday: true       # 是否使用加权距离
```

### 4. 预测过程优化

**改进点**：
1. **峰值调整应用**：在预测后自动应用节假日峰值校正
2. **节假日统计**：详细记录节假日预测的统计信息
3. **日志增强**：输出节假日预测的平均值、最大值、最小值

## 使用方式

### 配置示例

在模型配置文件中添加以下参数：

```yaml
train_params:
  n_neighbors_list: [3, 5, 7, 9, 11]  # 可以增加更大的K值用于节假日
  holiday_weight: 2.0                  # 节假日特征权重（建议1.5-3.0）
  use_weighted_holiday: true           # 启用加权距离
```

### 训练模型

训练过程会自动：
1. 识别节假日相关因子
2. 使用加权距离度量（如果启用）
3. 评估节假日数据的预测性能
4. 保存优化后的模型

### 预测

预测过程会自动：
1. 使用加权KNN进行预测
2. 应用节假日峰值调整
3. 输出详细的节假日预测统计

## 预期效果

### 改进前
- 节假日峰值预测偏差：通常低估 20-40%
- 节假日特征重要性：被其他特征稀释
- 预测准确性：节假日数据MAE较高

### 改进后
- 节假日峰值预测偏差：预期降低到 10-15%
- 节假日特征重要性：权重提升 2 倍
- 预测准确性：节假日数据MAE显著降低

## 技术细节

### 加权距离公式

对于节假日因子，使用加权欧氏距离：

```
d(x1, x2) = sqrt(Σ(wi * (x1i - x2i)²))
```

其中：
- `wi = holiday_weight` (默认2.0) 对于节假日因子
- `wi = 1.0` 对于其他因子

### 峰值调整公式

```
prediction_adjusted = prediction_base * adjustment_factor

其中：
adjustment_factor = min(peak_ratio, max_adjustment)
peak_ratio = hist_holiday_mean / hist_all_mean
max_adjustment = 1.5 (一般节假日) 或 1.6 (特定节假日类型)
```

## 注意事项

1. **数据质量**：确保历史数据中包含足够的节假日样本
2. **权重调整**：`holiday_weight` 参数需要根据实际数据调整，过大可能导致过拟合
3. **峰值上限**：峰值调整系数有上限，避免过度调整
4. **模型兼容性**：新模型与旧模型文件格式兼容，但需要重新训练

## 后续优化建议

1. **动态权重**：根据节假日类型动态调整权重
2. **季节性调整**：考虑不同季节的节假日峰值差异
3. **趋势融合**：结合去年同期偏移量算法
4. **A/B测试**：对比优化前后的预测效果

## 版本信息

- **优化日期**：2025-01-15
- **优化版本**：v2.1.0
- **主要改进**：节假日峰值预测优化

