# 车站预测功能实现总结

## ✅ 已完成的功能

### 1. 配置文件支持 (`config.yaml`)

**实现内容**：
- ✅ 支持配置车站筛选列表 (`STATION_FILTER_NAMES`)
- ✅ 支持配置数据库连接参数 (`db`)
- ✅ 支持配置查询起始日期 (`QUERY_START_DATE`)
- ✅ 自动读取配置文件（使用PyYAML库）
- ✅ 配置不存在时使用默认值

**修改的文件**：
- `/STFS_V1/script/人工算法/config.yaml` - 新建配置文件
- `/STFS_V1/script/人工算法/yunying.py` - 添加配置读取逻辑

**关键代码**：
```python
# yunying.py 开头
import yaml
import os

def load_config():
    config_path = os.path.join(os.path.dirname(__file__), 'config.yaml')
    if os.path.exists(config_path):
        with open(config_path, 'r', encoding='utf-8') as f:
            return yaml.safe_load(f)
    return {}

CONFIG = load_config()
STATION_FILTER_NAMES = CONFIG.get('STATION_FILTER_NAMES', [])
```

### 2. 车站过滤功能

**实现内容**：
- ✅ 动态生成SQL WHERE条件
- ✅ 支持通过车站名称列表过滤
- ✅ 空列表时查询所有车站
- ✅ 打印过滤信息便于调试

**修改的函数**：
```python
def _get_station_filter_sql(alias: str = "S") -> str:
    """根据配置返回车站过滤的SQL条件"""
    if not STATION_FILTER_NAMES:
        return ""  # 不过滤，查询所有车站
    
    # 生成IN条件
    station_list = "', '".join(STATION_FILTER_NAMES)
    return f"AND {alias}.STATION_NAME IN ('{station_list}')"
```

**SQL示例**：
```sql
-- 有过滤时
WHERE ... AND S.STATION_NAME IN ('五一广场', '侯家塘', '人民东路')

-- 无过滤时
WHERE ... 
```

### 3. 车站预测功能（完整实现）

**实现内容**：
- ✅ 后端API：`/predict_station_flow`
- ✅ 后端API：`/check_station_data_availability`
- ✅ 数据查询函数：`read_station_daily_flow_history()`
- ✅ 前端界面：完整的"车站预测"标签页
- ✅ 预测逻辑：基于历年最优增长率
- ✅ 准确率对比：与实际数据对比
- ✅ 高级设置：手动配置历年参考期和基期

**技术特点**：
- 复用线路预测的逻辑框架
- 使用不同的数据库表：`[StationFlowPredict].[dbo].[STATION_FLOW_HISTORY]`
- 字段映射：`STATION_ID` → `F_LINENO`, `STATION_NAME` → `F_LINENAME`
- 数据聚合：相同日期+相同车站的数据求和

### 4. 文档说明

**创建的文档**：
- ✅ `README_车站配置.md` - 详细的配置说明和使用指南
- ✅ `完成总结.md` (本文件) - 功能实现总结
- ✅ `config.yaml` - 包含详细的注释说明

## 📊 系统架构

```
┌─────────────────┐
│   config.yaml   │  配置文件
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│   yunying.py    │  数据层
├─────────────────┤
│ - load_config() │  读取配置
│ - get_db_conn() │  数据库连接
│ - _get_station  │  车站过滤
│   _filter_sql() │
│ - read_station  │  车站数据查询
│   _daily_flow   │
│   _history()    │
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│   web_app.py    │  API层
├─────────────────┤
│ /predict_       │  车站预测API
│  station_flow   │
│ /check_station  │  数据检查API
│  _data_avail    │
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│   index.html    │  前端界面
├─────────────────┤
│ stationPredict  │  车站预测标签页
│ Tab             │
│ - 日期选择      │
│ - 指标选择      │
│ - 历史年限      │
│ - 高级设置      │
│ - 结果展示      │
└─────────────────┘
```

## 🎯 性能优化

### 问题
- 143个车站全部预测耗时过长（3分钟+）
- 可能导致HTTP请求超时
- 服务器资源占用高

### 解决方案
1. **配置文件过滤**
   - 允许用户指定10-20个重点车站
   - 减少数据查询和计算量
   - 预测时间降至10-30秒

2. **SQL优化**
   - 使用IN条件直接过滤
   - 避免查询不需要的数据
   - 减少数据库I/O

3. **灵活配置**
   - 空列表 = 查询所有车站（适用于离线批量预测）
   - 指定列表 = 快速在线预测（适用于Web界面）

## 📝 使用流程

### 方式一：查询所有车站（适用于离线预测）

1. 编辑 `config.yaml`：
```yaml
STATION_FILTER_NAMES: []
```

2. 重启Flask：
```bash
pkill -f "python.*web_app"
python3 web_app.py &
```

3. 访问Web界面，选择较短日期范围（1-2天）

### 方式二：指定重点车站（推荐用于Web界面）

1. 查询数据库获取车站名称：
```python
from yunying import get_db_conn
import pandas as pd

conn = get_db_conn()
query = '''
SELECT DISTINCT TOP 50 STATION_NAME
FROM [StationFlowPredict].[dbo].[STATION_FLOW_HISTORY]
WHERE STATION_NAME IS NOT NULL
'''
df = pd.read_sql(query, conn)
print(df['STATION_NAME'].tolist())
```

2. 编辑 `config.yaml`：
```yaml
STATION_FILTER_NAMES:
  - 五一广场
  - 侯家塘
  - 人民东路
  - 星沙
  - 碧沙湖
  # ... 添加更多车站
```

3. 重启Flask并使用

## ⚠️ 注意事项

### 1. 车站名称必须精确匹配
- ❌ 错误：`五一广场站`
- ✅ 正确：`五一广场`
- ❌ 错误：`望城坡`
- ✅ 正确：`望城坡/汽车西站`

### 2. 配置修改后需重启
```bash
pkill -f "python.*web_app"
python3 web_app.py &
```

### 3. PyYAML依赖
确保已安装：
```bash
pip install pyyaml
```

## 🔧 故障排查

### 问题1：查询结果为0行
**可能原因**：
- 车站名称配置错误
- 日期范围内没有数据

**解决方法**：
1. 使用SQL查询验证车站名称
2. 检查数据库中的日期范围
3. 尝试设置 `STATION_FILTER_NAMES: []` 查询所有车站

### 问题2：Failed to fetch
**可能原因**：
- Flask服务未启动
- 服务器计算超时

**解决方法**：
1. 检查Flask进程：`ps aux | grep web_app`
2. 减少车站数量或预测天数
3. 增加请求超时时间

### 问题3：配置不生效
**原因**：未重启Flask

**解决**：
```bash
pkill -f "python.*web_app"
python3 web_app.py &
```

## 📦 文件清单

### 新增文件
- `config.yaml` - 配置文件
- `README_车站配置.md` - 配置说明
- `完成总结.md` - 本文件

### 修改文件
- `yunying.py` - 添加配置读取和车站过滤
- `web_app.py` - 添加车站预测API（`predict_station_flow`已在之前实现）
- `templates/index.html` - 车站预测标签页（已在之前实现）

## ✨ 功能亮点

1. **灵活配置**：支持配置文件，无需修改代码
2. **性能优化**：通过车站过滤大幅提升速度
3. **易于维护**：配置与代码分离
4. **向后兼容**：配置文件不存在时使用默认值
5. **详细文档**：提供完整的使用说明和故障排查指南

## 🎉 测试验证

### 测试1：配置读取
```bash
python3 -c "
from yunying import STATION_FILTER_NAMES, DB_CONFIG
print(f'车站过滤: {STATION_FILTER_NAMES}')
print(f'数据库: {DB_CONFIG[\"server\"]}')
"
```

### 测试2：数据查询
```bash
python3 -c "
from yunying import read_station_daily_flow_history
df = read_station_daily_flow_history('F_PKLCOUNT', '20241001', '20241005')
print(f'结果: {len(df)}行')
"
```

### 测试3：Web界面
1. 访问：http://localhost:4566
2. 切换到"🚉 车站预测"标签页
3. 选择日期、指标、历史年限
4. 点击"开始预测"
5. 查看预测结果和准确率

## 🚀 下一步建议

### 功能增强
1. [ ] 添加"推荐车站"功能：自动选择客流量TOP 20车站
2. [ ] 支持按线路筛选车站：如"只预测2号线的车站"
3. [ ] 缓存机制：缓存常用车站的历史数据
4. [ ] 批量导出：支持导出所有车站的预测结果

### 性能优化
1. [ ] 异步处理：使用Celery进行后台计算
2. [ ] 分页显示：前端分页展示大量预测结果
3. [ ] 进度提示：显示"正在处理第X/Y个车站"
4. [ ] 数据库索引：为STATION_NAME和SQUAD_DATE添加索引

### 用户体验
1. [ ] 车站搜索：前端提供车站名称搜索功能
2. [ ] 预设方案：保存常用的车站配置组合
3. [ ] 可视化增强：地图展示车站预测结果
4. [ ] 移动端适配：响应式设计

---

**完成时间**：2025-10-23  
**版本**：v1.0  
**状态**：✅ 已完成并测试

