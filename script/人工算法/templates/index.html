<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¢æµå†å²æ•°æ®æŸ¥è¯¢ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }
        
        /* æ ‡ç­¾é¡µåˆ‡æ¢ */
        .tabs {
            display: flex;
            gap: 10px;
            padding: 0 40px;
            background: white;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            user-select: none;
        }
        
        .tab:hover {
            color: #667eea;
            background: #f8f9fa;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #f8f9ff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        .query-panel {
            padding: 40px;
            background: #f8f9fa;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* æ—¥æœŸè‡ªåŠ¨å¡«å……åŠ¨ç”» */
        @keyframes highlight {
            0% { background-color: #fff; }
            50% { background-color: #e6f7ff; }
            100% { background-color: #fff; }
        }
        
        .auto-filled {
            animation: highlight 0.8s ease-in-out;
        }

        .date-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #48bb78;
            color: white;
        }

        .btn-secondary:hover {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(72, 187, 120, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .results-panel {
            padding: 40px;
            display: none;
        }

        .results-panel.show {
            display: block;
        }
        
        .stats-panel {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 2px solid #e0e0e0;
        }
        
        .stats-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .stat-card {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .stat-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
            transition: all 0.3s;
        }
        
        .stat-line-name {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .stat-details {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #555;
        }
        
        .stat-label {
            color: #666;
        }
        
        .stat-value {
            font-weight: 600;
            color: #333;
        }
        
        .stat-value.highlight {
            color: #667eea;
            font-size: 16px;
        }
        
        /* å¢é•¿ç‡é¢æ¿æ ·å¼ */
        .growth-panel {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
            border: 2px solid #667eea;
        }
        
        .growth-header {
            font-size: 20px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .growth-input-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .period-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .growth-result-panel {
            display: none;
            margin-top: 20px;
        }
        
        .growth-result-panel.show {
            display: block;
        }
        
        .growth-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #48bb78;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .growth-card.negative {
            border-left-color: #f56565;
        }
        
        .growth-card.network {
            border-left: 6px solid #667eea;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
        }
        
        .growth-card-content {
            margin-top: 15px;
        }
        
        .growth-card-content.collapsed {
            display: none;
        }
        
        .toggle-line-detail {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            margin-left: 10px;
            transition: all 0.3s;
        }
        
        .toggle-line-detail:hover {
            background: #5568d3;
            transform: scale(1.05);
        }
        
        .growth-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .growth-line-name {
            font-weight: 600;
            color: #333;
            font-size: 18px;
        }
        
        .growth-rate {
            font-size: 24px;
            font-weight: 700;
        }
        
        .growth-rate.positive {
            color: #48bb78;
        }
        
        .growth-rate.negative {
            color: #f56565;
        }
        
        .growth-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .growth-detail-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .growth-detail-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .growth-detail-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        /* åŸºæœŸè®¾ç½®åŒºåŸŸ */
        .base-period-section {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }
        
        .base-period-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        
        .base-period-header:hover {
            background: #f8f9fa;
            margin: -5px -10px;
            padding: 5px 10px;
            border-radius: 6px;
        }
        
        .base-period-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .base-period-title {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .base-period-dates {
            color: #667eea;
            font-weight: 600;
            font-size: 16px;
        }
        
        .expand-icon {
            font-size: 20px;
            transition: transform 0.3s;
        }
        
        .expand-icon.expanded {
            transform: rotate(180deg);
        }
        
        .base-period-inputs {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }
        
        .base-period-inputs.show {
            display: block;
        }
        
        /* å¤šå¹´è®¾ç½®åŒºåŸŸ */
        .multi-year-section {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 2px dashed #667eea;
        }
        
        .multi-year-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 5px;
            border-radius: 6px;
        }
        
        .multi-year-header:hover {
            background: #f8f9fa;
        }
        
        .multi-year-title {
            font-weight: 600;
            color: #667eea;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .multi-year-inputs {
            display: none;
            margin-top: 15px;
        }
        
        .multi-year-inputs.show {
            display: block;
        }
        
        .year-config-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .year-label {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 15px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .results-header h2 {
            color: #333;
            font-size: 24px;
        }

        .record-count {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .toggle-table-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .toggle-table-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
        
        .table-section {
            display: none;
        }
        
        .table-section.show {
            display: block;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
        }

        th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
            white-space: nowrap;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            color: #555;
            white-space: nowrap;
        }
        
        /* ä¸ºç¬¬ä¸€åˆ—ï¼ˆæ—¥æœŸï¼‰æ·»åŠ ç²—ä½“ */
        td:first-child {
            font-weight: 600;
            color: #667eea;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            display: none;
            background: #fed7d7;
            color: #c53030;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #c53030;
        }

        .error-message.show {
            display: block;
        }

        .metric-info {
            background: #e6f7ff;
            border-left: 4px solid #1890ff;
            padding: 12px;
            margin-top: 8px;
            border-radius: 4px;
            font-size: 13px;
            color: #0050b3;
        }

        @media (max-width: 768px) {
            .date-range {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .header h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš‡ å®¢æµå¢é•¿ç‡åˆ†æç³»ç»Ÿ</h1>
            <p>è‡ªåŠ¨å¯¹æ¯”ä¸Šæœˆæ•°æ®ï¼Œåˆ†æçº¿è·¯å®¢æµå¢é•¿è¶‹åŠ¿</p>
        </div>
        
        <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('growth')">
                <span>ğŸ“Š</span> å¢é•¿ç‡åˆ†æ
            </div>
            <div class="tab" onclick="switchTab('predict')">
                <span>ğŸ”®</span> çº¿è·¯é¢„æµ‹
            </div>
            <div class="tab" onclick="switchTab('stationPredict')">
                <span>ğŸš‰</span> è½¦ç«™é¢„æµ‹
            </div>
        </div>

        <!-- å¢é•¿ç‡åˆ†ææ ‡ç­¾é¡µ -->
        <div class="tab-content active" id="growthTab">
        <div class="query-panel">
            <div class="error-message" id="errorMessage"></div>
            
            <div class="form-group">
                <label for="metricType">æŒ‡æ ‡ç±»å‹</label>
                <select id="metricType">
                    <option value="F_PKLCOUNT">å®¢æµé‡</option>
                    <option value="F_ENTRANCE">è¿›ç«™äººæ•°</option>
                    <option value="F_EXIT">å‡ºç«™äººæ•°</option>
                    <option value="F_TRANSFER">æ¢ä¹˜äººæ•°</option>
                    <option value="F_BOARD_ALIGHT">ä¹˜é™é‡</option>
                </select>
                <div class="metric-info">
                    ğŸ’¡ é€‰æ‹©æ‚¨æƒ³è¦åˆ†æçš„å®¢æµæŒ‡æ ‡ç±»å‹
                </div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨è®¡ç®—å¢é•¿ç‡ï¼Œè¯·ç¨å€™...</p>
        </div>

        <div class="results-panel" id="resultsPanel" style="display: block;">
            <!-- å¢é•¿ç‡è®¡ç®—é¢æ¿ -->
            <div class="growth-panel" id="growthPanel" style="display: block; margin-top: 0;">
                <div class="growth-header">
                    <span>ğŸ“ˆ</span>
                    <span>å¢é•¿ç‡åˆ†æ</span>
                </div>
                
                <div class="growth-input-section">
                    <!-- åŸºæœŸè®¾ç½® -->
                    <div class="base-period-section">
                        <div class="base-period-header" onclick="toggleBasePeriod()">
                            <div class="base-period-info">
                                <div class="base-period-title">ğŸ“… åŸºæœŸï¼ˆç”¨äºå¯¹æ¯”çš„å‚è€ƒæ•°æ®ï¼‰</div>
                                <div class="base-period-dates" id="basePeriodDatesDisplay">
                                    è‡ªåŠ¨è®¡ç®—ä¸­...
                                </div>
                            </div>
                            <div class="expand-icon" id="basePeriodExpandIcon">ğŸ”½</div>
                        </div>
                        
                        <div class="base-period-inputs" id="basePeriodInputs">
                            <div class="metric-info" style="margin-bottom: 15px;">
                                ğŸ’¡ é»˜è®¤ä½¿ç”¨å¯¹æ¯”æœŸæ‰€åœ¨æœˆä»½çš„ä¸Šä¸€ä¸ªå®Œæ•´æœˆä»½ä½œä¸ºåŸºæœŸï¼Œä½ å¯ä»¥æ‰‹åŠ¨è°ƒæ•´
                            </div>
                            <div class="date-range">
                                <div class="form-group">
                                    <label for="baseStartDate">åŸºæœŸå¼€å§‹æ—¥æœŸ</label>
                                    <input type="date" id="baseStartDate">
                                </div>
                                <div class="form-group">
                                    <label for="baseEndDate">åŸºæœŸç»“æŸæ—¥æœŸ</label>
                                    <input type="date" id="baseEndDate">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="period-title">ğŸ”¹ å¯¹æ¯”æœŸï¼ˆè¦åˆ†æçš„æ—¥æœŸèŒƒå›´ï¼‰</div>
                    <div class="date-range">
                        <div class="form-group">
                            <label for="compareStartDate">å¼€å§‹æ—¥æœŸ</label>
                            <input type="date" id="compareStartDate">
                        </div>
                        <div class="form-group">
                            <label for="compareEndDate">ç»“æŸæ—¥æœŸ</label>
                            <input type="date" id="compareEndDate">
                        </div>
                    </div>
                    <div class="metric-info" style="margin-top: -15px;">
                        ğŸ’¡ ä¾‹å¦‚ï¼šé€‰æ‹©2025å¹´5æœˆ1æ—¥-5æœˆ5æ—¥ï¼Œç³»ç»Ÿè‡ªåŠ¨ä½¿ç”¨4æœˆæ•´æœˆä½œä¸ºåŸºæœŸå¯¹æ¯”
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label for="yearRange">åŒæ¯”å¹´é™ï¼ˆå¯¹æ¯”å‰å‡ å¹´åŒæœŸï¼‰</label>
                        <select id="yearRange" onchange="updateMultiYearConfig()">
                            <option value="0">ä»…å¯¹æ¯”åŸºæœŸï¼ˆä¸çœ‹å†å¹´ï¼‰</option>
                            <option value="1">å¯¹æ¯”å»å¹´åŒæœŸï¼ˆ1å¹´ï¼‰</option>
                            <option value="2">å¯¹æ¯”å‰2å¹´åŒæœŸ</option>
                            <option value="3" selected>å¯¹æ¯”å‰3å¹´åŒæœŸ</option>
                            <option value="4">å¯¹æ¯”å‰4å¹´åŒæœŸ</option>
                            <option value="5">å¯¹æ¯”å‰5å¹´åŒæœŸ</option>
                        </select>
                        <div class="metric-info">
                            ğŸ’¡ é€‰æ‹©åå°†è®¡ç®—æŒ‡å®šæ—¥æœŸç›¸æ¯”å†å¹´åŒæœŸçš„å¢é•¿è¶‹åŠ¿
                        </div>
                    </div>
                    
                    <!-- å¤šå¹´é«˜çº§è®¾ç½® -->
                    <div class="multi-year-section" id="multiYearSection" style="display: none;">
                        <div class="multi-year-header" onclick="toggleMultiYearConfig()">
                            <div class="multi-year-title">
                                <span>âš™ï¸</span>
                                <span>é«˜çº§è®¾ç½®ï¼šæ‰‹åŠ¨è°ƒæ•´å„å¹´æ—¥æœŸ</span>
                            </div>
                            <div class="expand-icon" id="multiYearExpandIcon">ğŸ”½</div>
                        </div>
                        
                        <div class="multi-year-inputs" id="multiYearInputs">
                            <div class="metric-info" style="margin-bottom: 15px;">
                                ğŸ’¡ é»˜è®¤ä½¿ç”¨ç›¸åŒçš„æ—¥æœŸèŒƒå›´ï¼ˆå¦‚éƒ½æ˜¯5æœˆ1-5æ—¥ï¼‰ï¼Œä½ å¯ä»¥ä¸ºæ¯å¹´å•ç‹¬è®¾ç½®
                            </div>
                            <div id="yearConfigContainer"></div>
                        </div>
                    </div>
                    
                    <div class="button-group" style="margin-top: 20px;">
                        <button class="btn btn-primary" id="calculateGrowthBtn" onclick="calculateGrowthAuto()">
                            <span>ğŸ“Š</span>
                            <span>è®¡ç®—å¢é•¿ç‡</span>
                        </button>
                        <button class="btn btn-secondary" id="exportGrowthBtn" onclick="exportGrowthData()" disabled>
                            <span>ğŸ“¥</span>
                            <span>å¯¼å‡ºåˆ†æè¡¨æŠ¥</span>
                        </button>
                    </div>
                </div>
                
                <!-- å¢é•¿ç‡ç»“æœ -->
                <div class="growth-result-panel" id="growthResultPanel">
                    <div class="period-title" style="margin-bottom: 15px;">
                        ğŸ“Š å¢é•¿ç‡åˆ†æç»“æœ
                    </div>
                    
                    <!-- æœ€å¤§å¢é•¿ç‡æ›²çº¿å›¾è¡¨ -->
                    <div class="chart-container" id="maxGrowthChartContainer" style="display: none;">
                        <div class="chart-title">
                            <span>ğŸ†</span>
                            <span>å†å¹´æœ€ä¼˜è¡¨ç°æ›²çº¿ï¼ˆå„çº¿è·¯æ¯å¤©çš„æœ€å¤§å¢é•¿ç‡ï¼‰</span>
                        </div>
                        <canvas id="maxGrowthChart"></canvas>
                    </div>
                    
                    <!-- å¢é•¿ç‡æ—¶é—´åºåˆ—å›¾è¡¨ -->
                    <div class="chart-container" id="growthChartContainer" style="display: none;">
                        <div class="chart-title">
                            <span>ğŸ“Š</span>
                            <span>å¢é•¿ç‡æ—¶é—´åºåˆ—ï¼ˆæ‰€æœ‰å¹´ä»½å¯¹æ¯”ï¼‰</span>
                        </div>
                        <canvas id="growthChart"></canvas>
                    </div>
                    
                    <div id="growthResultsContainer"></div>
                </div>
            </div>
        </div>
    </div>
    </div>
    
    <!-- å®¢æµé¢„æµ‹æ ‡ç­¾é¡µ -->
    <div class="tab-content" id="predictTab">
        <div class="query-panel">
            <div class="error-message" id="predictErrorMessage"></div>
            
            <div class="form-group">
                <label for="predictMetricType">æŒ‡æ ‡ç±»å‹</label>
                <select id="predictMetricType" onchange="checkPredictDataAvailability()">
                    <option value="F_PKLCOUNT">å®¢æµé‡</option>
                    <option value="F_ENTRANCE">è¿›ç«™äººæ•°</option>
                    <option value="F_EXIT">å‡ºç«™äººæ•°</option>
                    <option value="F_TRANSFER">æ¢ä¹˜äººæ•°</option>
                    <option value="F_BOARD_ALIGHT">ä¹˜é™é‡</option>
                </select>
            </div>
            
            <div class="period-title" style="margin-top: 20px;">ğŸ”® é¢„æµ‹ç›®æ ‡æ—¥æœŸ</div>
            <div class="date-range">
                <div class="form-group">
                    <label for="predictStartDate">å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" id="predictStartDate">
                </div>
                <div class="form-group">
                    <label for="predictEndDate">ç»“æŸæ—¥æœŸ</label>
                    <input type="date" id="predictEndDate">
                </div>
            </div>
            <div class="metric-info" style="margin-top: -15px;">
                ğŸ’¡ é€‰æ‹©è¦é¢„æµ‹çš„æ—¥æœŸèŒƒå›´ï¼ˆå¦‚ï¼š2025å¹´4æœˆ30æ—¥-5æœˆ5æ—¥ï¼‰
            </div>
            
            <div class="form-group" style="margin-top: 20px;">
                <label for="historyYears">å‚è€ƒå†å²å¹´é™</label>
                <select id="historyYears" onchange="updatePredictMultiYearConfig()">
                    <option value="1">å‚è€ƒå‰1å¹´</option>
                    <option value="2" selected>å‚è€ƒå‰2å¹´</option>
                    <option value="3">å‚è€ƒå‰3å¹´</option>
                    <option value="4">å‚è€ƒå‰4å¹´</option>
                    <option value="5">å‚è€ƒå‰5å¹´</option>
                </select>
                <div class="metric-info">
                    ğŸ’¡ åŸºäºå†å¹´åŒæœŸçš„æœ€ä¼˜å¢é•¿ç‡è¿›è¡Œé¢„æµ‹
                </div>
            </div>
            
            <!-- æ•°æ®å¯ç”¨æ€§æ£€æŸ¥æç¤º -->
            <div id="predictDataCheck" style="margin-top: 20px; padding: 12px; border-radius: 8px; display: none;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div id="predictDataCheckIcon" style="font-size: 20px;"></div>
                    <div id="predictDataCheckText" style="flex: 1;"></div>
                    <button class="btn btn-secondary" onclick="checkPredictDataAvailability()" style="padding: 6px 12px; font-size: 13px;">
                        ğŸ” æ£€æŸ¥æ•°æ®
                    </button>
                </div>
            </div>
            
            <div class="base-period-section" style="margin-top: 20px;">
                <div class="base-period-info">
                    <div class="base-period-title">ğŸ“… é¢„æµ‹åŸºæœŸï¼ˆå½“å¹´ä¸Šæœˆï¼‰</div>
                    <div class="base-period-dates" id="predictBasePeriodDisplay">
                        è¯·å…ˆé€‰æ‹©é¢„æµ‹æ—¥æœŸ
                    </div>
                </div>
            </div>
            
            <!-- å†å¹´å‚è€ƒé…ç½® -->
            <div class="multi-year-section" id="predictMultiYearSection" style="display: none;">
                <div class="multi-year-header" onclick="togglePredictMultiYearConfig()">
                    <div class="multi-year-title">
                        <span>âš™ï¸</span>
                        <span>é«˜çº§è®¾ç½®ï¼šæ‰‹åŠ¨è°ƒæ•´å†å¹´å‚è€ƒæ—¥æœŸ</span>
                    </div>
                    <div class="expand-icon" id="predictMultiYearExpandIcon">ğŸ”½</div>
                </div>
                
                <div class="multi-year-inputs" id="predictMultiYearInputs">
                    <div class="metric-info" style="margin-bottom: 15px;">
                        ğŸ’¡ é»˜è®¤ä½¿ç”¨ç›¸åŒæ—¥æœŸï¼ˆå¦‚éƒ½æ˜¯4æœˆ30-5æœˆ5æ—¥ï¼‰ï¼Œå¯ä¸ºæ¯å¹´å•ç‹¬è®¾ç½®å‚è€ƒæœŸå’ŒåŸºæœŸ
                    </div>
                    <div id="predictYearConfigContainer"></div>
                </div>
            </div>
            
            <div class="button-group" style="margin-top: 30px;">
                <button class="btn btn-primary" id="predictBtn" onclick="predictFlow()">
                    <span>ğŸ”®</span>
                    <span>å¼€å§‹é¢„æµ‹</span>
                </button>
            </div>
        </div>
        
        <div class="loading" id="predictLoading">
            <div class="spinner"></div>
            <p>æ­£åœ¨é¢„æµ‹å®¢æµï¼Œè¯·ç¨å€™...</p>
        </div>
        
        <div class="results-panel" id="predictResultsPanel" style="display: none;">
            <div class="results-header">
                <h2>é¢„æµ‹ç»“æœ</h2>
                <span class="record-count" id="predictRecordCount">0 æ¡è®°å½•</span>
            </div>
            
            <!-- é¢„æµ‹å‡†ç¡®ç‡ç»Ÿè®¡ -->
            <div class="stats-panel" id="predictAccuracyPanel" style="display: none;">
                <div class="stats-title">
                    <span>ğŸ¯</span>
                    <span>é¢„æµ‹å‡†ç¡®ç‡ç»Ÿè®¡</span>
                </div>
                <div class="stats-grid" id="predictAccuracyGrid"></div>
            </div>
            
            <!-- é¢„æµ‹æ•°æ®å±•ç¤º -->
            <div id="predictDataContainer"></div>
        </div>
    </div>

    <!-- è½¦ç«™é¢„æµ‹æ ‡ç­¾é¡µ -->
    <div class="tab-content" id="stationPredictTab">
        <div class="query-panel">
            <div class="error-message" id="stationPredictErrorMessage"></div>
            
            <div class="form-group">
                <label for="stationPredictMetricType">æŒ‡æ ‡ç±»å‹</label>
                <select id="stationPredictMetricType" onchange="checkStationDataAvailability()">
                    <option value="F_PKLCOUNT">å®¢æµé‡</option>
                    <option value="F_ENTRANCE">è¿›ç«™äººæ•°</option>
                    <option value="F_EXIT">å‡ºç«™äººæ•°</option>
                    <option value="F_TRANSFER">æ¢ä¹˜äººæ•°</option>
                    <option value="F_BOARD_ALIGHT">ä¹˜é™é‡</option>
                </select>
            </div>
            
            <div class="period-title" style="margin-top: 20px;">ğŸš‰ é¢„æµ‹ç›®æ ‡æ—¥æœŸ</div>
            <div class="date-range">
                <div class="form-group">
                    <label for="stationPredictStartDate">å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" id="stationPredictStartDate">
                </div>
                <div class="form-group">
                    <label for="stationPredictEndDate">ç»“æŸæ—¥æœŸ</label>
                    <input type="date" id="stationPredictEndDate">
                </div>
            </div>
            <div class="metric-info" style="margin-top: -15px;">
                ğŸ’¡ é€‰æ‹©è¦é¢„æµ‹çš„æ—¥æœŸèŒƒå›´ï¼ˆå¦‚ï¼š2025å¹´4æœˆ30æ—¥-5æœˆ5æ—¥ï¼‰
            </div>
            
            <div class="form-group" style="margin-top: 20px;">
                <label for="stationHistoryYears">å‚è€ƒå†å²å¹´é™</label>
                <select id="stationHistoryYears" onchange="updateStationMultiYearConfig()">
                    <option value="1">å‚è€ƒå‰1å¹´</option>
                    <option value="2" selected>å‚è€ƒå‰2å¹´</option>
                    <option value="3">å‚è€ƒå‰3å¹´</option>
                    <option value="4">å‚è€ƒå‰4å¹´</option>
                    <option value="5">å‚è€ƒå‰5å¹´</option>
                </select>
                <div class="metric-info">
                    ğŸ’¡ åŸºäºå†å¹´åŒæœŸè½¦ç«™çš„æœ€ä¼˜å¢é•¿ç‡è¿›è¡Œé¢„æµ‹
                </div>
            </div>
            
            <!-- æ•°æ®å¯ç”¨æ€§æ£€æŸ¥æç¤º -->
            <div id="stationDataCheck" style="margin-top: 20px; padding: 12px; border-radius: 8px; display: none;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div id="stationDataCheckIcon" style="font-size: 20px;"></div>
                    <div id="stationDataCheckText" style="flex: 1;"></div>
                    <button class="btn btn-secondary" onclick="checkStationDataAvailability()" style="padding: 6px 12px; font-size: 13px;">
                        ğŸ” æ£€æŸ¥æ•°æ®
                    </button>
                </div>
            </div>
            
            <div class="base-period-section" style="margin-top: 20px;">
                <div class="base-period-info">
                    <div class="base-period-title">ğŸ“… é¢„æµ‹åŸºæœŸï¼ˆå½“å¹´ä¸Šæœˆï¼‰</div>
                    <div class="base-period-dates" id="stationBasePeriodDisplay">
                        è¯·å…ˆé€‰æ‹©é¢„æµ‹æ—¥æœŸ
                    </div>
                </div>
            </div>
            
            <!-- å†å¹´å‚è€ƒé…ç½® -->
            <div class="multi-year-section" id="stationMultiYearSection" style="display: none;">
                <div class="multi-year-header" onclick="toggleStationMultiYearConfig()">
                    <div class="multi-year-title">
                        <span>âš™ï¸</span>
                        <span>é«˜çº§è®¾ç½®ï¼šæ‰‹åŠ¨è°ƒæ•´å†å¹´å‚è€ƒæ—¥æœŸ</span>
                    </div>
                    <div class="expand-icon" id="stationMultiYearExpandIcon">ğŸ”½</div>
                </div>
                
                <div class="multi-year-inputs" id="stationMultiYearInputs">
                    <div class="metric-info" style="margin-bottom: 15px;">
                        ğŸ’¡ é»˜è®¤ä½¿ç”¨ç›¸åŒæ—¥æœŸï¼ˆå¦‚éƒ½æ˜¯4æœˆ30-5æœˆ5æ—¥ï¼‰ï¼Œå¯ä¸ºæ¯å¹´å•ç‹¬è®¾ç½®å‚è€ƒæœŸå’ŒåŸºæœŸ
                    </div>
                    <div id="stationYearConfigContainer"></div>
                </div>
            </div>
            
            <div class="button-group" style="margin-top: 30px;">
                <button class="btn btn-primary" id="stationPredictBtn" onclick="predictStationFlow()">
                    <span>ğŸš‰</span>
                    <span>å¼€å§‹é¢„æµ‹</span>
                </button>
            </div>
        </div>
        
        <div class="loading" id="stationPredictLoading">
            <div class="spinner"></div>
            <p>æ­£åœ¨é¢„æµ‹è½¦ç«™å®¢æµï¼Œè¯·ç¨å€™...</p>
        </div>
        
        <div class="results-panel" id="stationPredictResultsPanel" style="display: none;">
            <div class="results-header">
                <h2>è½¦ç«™é¢„æµ‹ç»“æœ</h2>
                <span class="record-count" id="stationPredictRecordCount">0 æ¡è®°å½•</span>
            </div>
            
            <!-- é¢„æµ‹å‡†ç¡®ç‡ç»Ÿè®¡ -->
            <div class="stats-panel" id="stationAccuracyPanel" style="display: none;">
                <div class="stats-title">
                    <span>ğŸ¯</span>
                    <span>é¢„æµ‹å‡†ç¡®ç‡ç»Ÿè®¡</span>
                </div>
                <div class="stats-grid" id="stationAccuracyGrid"></div>
            </div>
            
            <!-- é¢„æµ‹æ•°æ®å±•ç¤º -->
            <div id="stationDataContainer"></div>
        </div>
    </div>

    <script>
        // åˆ—åä¸­æ–‡æ˜ å°„
        const columnNameMap = {
            'F_DATE': 'æ—¥æœŸ',
            'F_LINENO': 'çº¿è·¯ç¼–å·',
            'F_LINENAME': 'çº¿è·¯åç§°',
            'WEATHER_TYPE': 'å¤©æ°”ç±»å‹',
            'F_DATEFEATURES': 'æ—¥æœŸç‰¹å¾'
        };
        
        // æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DDï¼ˆæœ¬åœ°æ—¶é—´ï¼Œé¿å…æ—¶åŒºé—®é¢˜ï¼‰
        function formatDateLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // è®¡ç®—å¼€å§‹æ—¥æœŸæ‰€åœ¨æœˆä»½çš„æœˆæœ«
        function getMonthEnd(startDate) {
            const endDate = new Date(startDate);
            // è®¾ç½®ä¸ºä¸‹ä¸ªæœˆçš„ç¬¬0å¤©ï¼Œå³å½“æœˆçš„æœ€åä¸€å¤©
            endDate.setMonth(endDate.getMonth() + 1);
            endDate.setDate(0);
            return endDate;
        }
        
        // è®¾ç½®é»˜è®¤æ—¥æœŸ
        window.onload = function() {
            const today = new Date();
            
            // è®¾ç½®å¯¹æ¯”æœŸé»˜è®¤ä¸ºä»Šå¤©
            document.getElementById('compareEndDate').valueAsDate = today;
            
            // è®¾ç½®å¯¹æ¯”æœŸå¼€å§‹æ—¥æœŸä¸º5å¤©å‰ï¼ˆç¤ºä¾‹ï¼šå‡æœŸï¼‰
            const fiveDaysAgo = new Date(today);
            fiveDaysAgo.setDate(fiveDaysAgo.getDate() - 4); // -4å¤© = 5å¤©èŒƒå›´
            document.getElementById('compareStartDate').valueAsDate = fiveDaysAgo;
            
            // åˆå§‹åŒ–åŸºæœŸæ˜¾ç¤º
            updateBasePeriodDisplay();
            
            // åˆå§‹åŒ–å¤šå¹´è®¾ç½®
            updateMultiYearConfig();
            
            // ç›‘å¬å¯¹æ¯”æœŸå¼€å§‹æ—¥æœŸå˜åŒ–ï¼Œè‡ªåŠ¨è®¾ç½®ç»“æŸæ—¥æœŸå’Œæ›´æ–°åŸºæœŸ
            document.getElementById('compareStartDate').addEventListener('change', function() {
                const startDate = this.valueAsDate;
                if (startDate) {
                    // é»˜è®¤è®¾ç½®ä¸º5å¤©å
                    const endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + 4);
                    const endDateInput = document.getElementById('compareEndDate');
                    endDateInput.valueAsDate = endDate;
                    
                    // æ·»åŠ é«˜äº®åŠ¨ç”»æ•ˆæœ
                    endDateInput.classList.add('auto-filled');
                    setTimeout(() => {
                        endDateInput.classList.remove('auto-filled');
                    }, 800);
                    
                    // æ›´æ–°åŸºæœŸæ˜¾ç¤º
                    updateBasePeriodDisplay();
                    
                    // æ›´æ–°å¤šå¹´é…ç½®
                    updateMultiYearConfig();
                }
            });
            
            // ç›‘å¬å¯¹æ¯”æœŸç»“æŸæ—¥æœŸå˜åŒ–ï¼Œä¹Ÿæ›´æ–°åŸºæœŸ
            document.getElementById('compareEndDate').addEventListener('change', function() {
                updateBasePeriodDisplay();
                updateMultiYearConfig();
            });
            
            // ç›‘å¬åŸºæœŸè¾“å…¥æ¡†çš„æ‰‹åŠ¨ä¿®æ”¹ï¼Œæ›´æ–°æ˜¾ç¤º
            document.getElementById('baseStartDate').addEventListener('change', function() {
                const baseStartDate = this.value;
                const baseEndDate = document.getElementById('baseEndDate').value;
                const basePeriodDatesDisplay = document.getElementById('basePeriodDatesDisplay');
                
                if (baseStartDate && baseEndDate) {
                    // è®¡ç®—å¤©æ•°
                    const start = new Date(baseStartDate);
                    const end = new Date(baseEndDate);
                    const days = Math.round((end - start) / (1000 * 60 * 60 * 24)) + 1;
                    basePeriodDatesDisplay.textContent = `${baseStartDate} è‡³ ${baseEndDate} ï¼ˆå…±${days}å¤©ï¼‰`;
                }
            });
            
            document.getElementById('baseEndDate').addEventListener('change', function() {
                const baseStartDate = document.getElementById('baseStartDate').value;
                const baseEndDate = this.value;
                const basePeriodDatesDisplay = document.getElementById('basePeriodDatesDisplay');
                
                if (baseStartDate && baseEndDate) {
                    // è®¡ç®—å¤©æ•°
                    const start = new Date(baseStartDate);
                    const end = new Date(baseEndDate);
                    const days = Math.round((end - start) / (1000 * 60 * 60 * 24)) + 1;
                    basePeriodDatesDisplay.textContent = `${baseStartDate} è‡³ ${baseEndDate} ï¼ˆå…±${days}å¤©ï¼‰`;
                }
            });
        };

        let currentQueryData = null;
        let currentGrowthData = null;
        let growthChartInstance = null;
        let maxGrowthChartInstance = null;
        
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µ
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            if (tabName === 'growth') {
                document.getElementById('growthTab').classList.add('active');
                document.querySelectorAll('.tab')[0].classList.add('active');
            } else if (tabName === 'predict') {
                document.getElementById('predictTab').classList.add('active');
                document.querySelectorAll('.tab')[1].classList.add('active');
            } else if (tabName === 'stationPredict') {
                document.getElementById('stationPredictTab').classList.add('active');
                document.querySelectorAll('.tab')[2].classList.add('active');
            }
        }

        function toggleBasePeriod() {
            const basePeriodInputs = document.getElementById('basePeriodInputs');
            const expandIcon = document.getElementById('basePeriodExpandIcon');
            
            if (basePeriodInputs.classList.contains('show')) {
                basePeriodInputs.classList.remove('show');
                expandIcon.classList.remove('expanded');
            } else {
                basePeriodInputs.classList.add('show');
                expandIcon.classList.add('expanded');
            }
        }
        
        function toggleMultiYearConfig() {
            const multiYearInputs = document.getElementById('multiYearInputs');
            const expandIcon = document.getElementById('multiYearExpandIcon');
            
            if (multiYearInputs.classList.contains('show')) {
                multiYearInputs.classList.remove('show');
                expandIcon.classList.remove('expanded');
            } else {
                multiYearInputs.classList.add('show');
                expandIcon.classList.add('expanded');
            }
        }
        
        function updateMultiYearConfig() {
            const yearRange = parseInt(document.getElementById('yearRange').value);
            const multiYearSection = document.getElementById('multiYearSection');
            const yearConfigContainer = document.getElementById('yearConfigContainer');
            
            // å¦‚æœå¹´é™ä¸º0ï¼Œéšè—å¤šå¹´è®¾ç½®
            if (yearRange === 0) {
                multiYearSection.style.display = 'none';
                return;
            }
            
            // æ˜¾ç¤ºå¤šå¹´è®¾ç½®åŒºåŸŸ
            multiYearSection.style.display = 'block';
            
            // æ¸…ç©ºå®¹å™¨
            yearConfigContainer.innerHTML = '';
            
            // è·å–å½“å‰å¯¹æ¯”æœŸæ—¥æœŸ
            const compareStartDate = document.getElementById('compareStartDate').value;
            const compareEndDate = document.getElementById('compareEndDate').value;
            
            if (!compareStartDate || !compareEndDate) {
                yearConfigContainer.innerHTML = '<div class="metric-info">è¯·å…ˆé€‰æ‹©å¯¹æ¯”æœŸæ—¥æœŸ</div>';
                return;
            }
            
            const currentYear = new Date(compareStartDate).getFullYear();
            
            // ä¸ºæ¯å¹´ç”Ÿæˆé…ç½®é¡¹
            for (let i = 0; i <= yearRange; i++) {
                const year = currentYear - i;
                const isCurrent = (i === 0);
                
                // è®¡ç®—è¯¥å¹´çš„é»˜è®¤æ—¥æœŸ
                const yearCompareStart = compareStartDate.replace(/^\d{4}/, year);
                const yearCompareEnd = compareEndDate.replace(/^\d{4}/, year);
                
                // è®¡ç®—è¯¥å¹´çš„åŸºæœŸï¼ˆä¸Šæœˆæ•´æœˆï¼‰
                const compareStart = new Date(yearCompareStart);
                const compareMonth = compareStart.getMonth();
                const compareYearNum = compareStart.getFullYear();
                
                let baseMonth = compareMonth - 1;
                let baseYear = compareYearNum;
                if (baseMonth < 0) {
                    baseMonth = 11;
                    baseYear--;
                }
                
                const baseStart = new Date(baseYear, baseMonth, 1);
                const baseEnd = new Date(baseYear, baseMonth + 1, 0);
                const yearBaseStart = formatDateLocal(baseStart);
                const yearBaseEnd = formatDateLocal(baseEnd);
                
                const yearConfig = document.createElement('div');
                yearConfig.className = 'year-config-item';
                yearConfig.innerHTML = `
                    <div class="year-label">${year}å¹´${isCurrent ? 'ï¼ˆå½“å¹´ï¼‰' : 'ï¼ˆå‰' + i + 'å¹´ï¼‰'}</div>
                    <div class="date-range">
                        <div class="form-group">
                            <label for="year${year}CompareStart">å¯¹æ¯”æœŸå¼€å§‹</label>
                            <input type="date" id="year${year}CompareStart" value="${yearCompareStart}">
                        </div>
                        <div class="form-group">
                            <label for="year${year}CompareEnd">å¯¹æ¯”æœŸç»“æŸ</label>
                            <input type="date" id="year${year}CompareEnd" value="${yearCompareEnd}">
                        </div>
                    </div>
                    <div class="date-range" style="margin-top: 10px;">
                        <div class="form-group">
                            <label for="year${year}BaseStart">åŸºæœŸå¼€å§‹</label>
                            <input type="date" id="year${year}BaseStart" value="${yearBaseStart}">
                        </div>
                        <div class="form-group">
                            <label for="year${year}BaseEnd">åŸºæœŸç»“æŸ</label>
                            <input type="date" id="year${year}BaseEnd" value="${yearBaseEnd}">
                        </div>
                    </div>
                `;
                yearConfigContainer.appendChild(yearConfig);
            }
        }
        
        function updateBasePeriodDisplay() {
            const compareStartDate = document.getElementById('compareStartDate').value;
            const baseStartInput = document.getElementById('baseStartDate');
            const baseEndInput = document.getElementById('baseEndDate');
            const basePeriodDatesDisplay = document.getElementById('basePeriodDatesDisplay');
            
            if (compareStartDate) {
                // è®¡ç®—åŸºæœŸ - å¯¹æ¯”æœŸæ‰€åœ¨æœˆä»½çš„ä¸Šä¸€ä¸ªå®Œæ•´æœˆä»½
                const compareStart = new Date(compareStartDate);
                
                // è·å–å¯¹æ¯”æœŸå¼€å§‹æ—¥æœŸçš„å¹´æœˆ
                const compareYear = compareStart.getFullYear();
                const compareMonth = compareStart.getMonth(); // 0-11
                
                // åŸºæœŸæ˜¯ä¸Šä¸€ä¸ªæœˆ
                let baseYear = compareYear;
                let baseMonth = compareMonth - 1;
                
                // å¦‚æœæ˜¯1æœˆï¼Œåˆ™åŸºæœŸæ˜¯ä¸Šä¸€å¹´çš„12æœˆ
                if (baseMonth < 0) {
                    baseMonth = 11;
                    baseYear--;
                }
                
                // åŸºæœŸå¼€å§‹æ—¥æœŸ = ä¸Šæœˆ1æ—¥
                const baseStart = new Date(baseYear, baseMonth, 1);
                
                // åŸºæœŸç»“æŸæ—¥æœŸ = ä¸Šæœˆæœ€åä¸€å¤©
                const baseEnd = new Date(baseYear, baseMonth + 1, 0); // ä¸‹æœˆçš„ç¬¬0å¤© = å½“æœˆæœ€åä¸€å¤©
                
                // ä½¿ç”¨æœ¬åœ°æ—¶é—´æ ¼å¼åŒ–ï¼Œé¿å…æ—¶åŒºé—®é¢˜
                const baseStartDate = formatDateLocal(baseStart);
                const baseEndDate = formatDateLocal(baseEnd);
                
                // è®¡ç®—å¤©æ•°
                const days = baseEnd.getDate(); // æœˆä»½çš„æœ€åä¸€å¤©å°±æ˜¯å¤©æ•°
                
                // æ›´æ–°éšè—çš„è¾“å…¥æ¡†
                baseStartInput.value = baseStartDate;
                baseEndInput.value = baseEndDate;
                
                // æ›´æ–°æ˜¾ç¤º - æ˜¾ç¤ºæœˆä»½åç§°
                const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
                basePeriodDatesDisplay.textContent = `${baseStartDate} è‡³ ${baseEndDate} ï¼ˆ${baseYear}å¹´${monthNames[baseMonth]}ï¼Œå…±${days}å¤©ï¼‰`;
            } else {
                basePeriodDatesDisplay.textContent = 'è¯·å…ˆé€‰æ‹©å¯¹æ¯”æœŸæ—¥æœŸ';
            }
        }

        function toggleLineDetail(lineIndex) {
            const content = document.getElementById(`lineContent${lineIndex}`);
            const icon = document.getElementById(`toggleIcon${lineIndex}`);
            const text = document.getElementById(`toggleText${lineIndex}`);
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.textContent = 'ğŸ™ˆ';
                text.textContent = 'æ”¶èµ·è¯¦æƒ…';
            } else {
                content.classList.add('collapsed');
                icon.textContent = 'ğŸ‘ï¸';
                text.textContent = 'æŸ¥çœ‹è¯¦æƒ…';
            }
        }
        
        function toggleDataTable() {
            const tableSection = document.getElementById('tableSection');
            const toggleIcon = document.getElementById('toggleIcon');
            const toggleText = document.getElementById('toggleText');
            
            if (tableSection.classList.contains('show')) {
                tableSection.classList.remove('show');
                toggleIcon.textContent = 'ğŸ‘ï¸';
                toggleText.textContent = 'æŸ¥çœ‹è¯¦ç»†æ•°æ®';
            } else {
                tableSection.classList.add('show');
                toggleIcon.textContent = 'ğŸ™ˆ';
                toggleText.textContent = 'éšè—è¯¦ç»†æ•°æ®';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = 'âŒ ' + message;
            errorDiv.classList.add('show');
            setTimeout(() => {
                errorDiv.classList.remove('show');
            }, 5000);
        }

        function queryData() {
            const metricType = document.getElementById('metricType').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                showError('è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸå’Œç»“æŸæ—¥æœŸ');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showError('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            document.getElementById('loading').classList.add('show');
            document.getElementById('resultsPanel').classList.remove('show');
            document.getElementById('queryBtn').disabled = true;
            document.getElementById('exportBtn').disabled = true;

            // ä¿å­˜å½“å‰æŸ¥è¯¢å‚æ•°
            currentQueryData = {
                metric_type: metricType,
                start_date: startDate,
                end_date: endDate
            };

            // å‘é€æŸ¥è¯¢è¯·æ±‚
            fetch('/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(currentQueryData)
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('queryBtn').disabled = false;

                if (data.success) {
                    displayResults(data);
                    document.getElementById('exportBtn').disabled = false;
                } else {
                    showError(data.error || 'æŸ¥è¯¢å¤±è´¥');
                }
            })
            .catch(error => {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('queryBtn').disabled = false;
                showError('ç½‘ç»œé”™è¯¯: ' + error.message);
            });
        }

        function displayResults(data) {
            const resultsPanel = document.getElementById('resultsPanel');
            const tableHead = document.getElementById('tableHead');
            const tableBody = document.getElementById('tableBody');
            const recordCount = document.getElementById('recordCount');
            const statsPanel = document.getElementById('statsPanel');
            const statsGrid = document.getElementById('statsGrid');
            const statsMetricName = document.getElementById('statsMetricName');

            // æ¸…ç©ºè¡¨æ ¼
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            statsGrid.innerHTML = '';

            // æ˜¾ç¤ºè®°å½•æ•°
            recordCount.textContent = `${data.total_records} æ¡è®°å½•`;

            // æ˜¾ç¤ºçº¿è·¯ç»Ÿè®¡
            if (data.line_stats && data.line_stats.length > 0) {
                statsMetricName.textContent = `${data.metric_name}ç»Ÿè®¡`;
                statsPanel.style.display = 'block';
                
                data.line_stats.forEach(stat => {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.innerHTML = `
                        <div class="stat-line-name">${stat.F_LINENAME || 'æœªçŸ¥çº¿è·¯'}</div>
                        <div class="stat-details">
                            <div class="stat-item">
                                <span class="stat-label">å¹³å‡${data.metric_name}:</span>
                                <span class="stat-value highlight">${stat['å¹³å‡å€¼'].toLocaleString('zh-CN')}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">æ€»è®¡:</span>
                                <span class="stat-value">${stat['æ€»è®¡'].toLocaleString('zh-CN')}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">ç»Ÿè®¡å¤©æ•°:</span>
                                <span class="stat-value">${stat['å¤©æ•°']} å¤©</span>
                            </div>
                        </div>
                    `;
                    statsGrid.appendChild(card);
                });
            } else {
                statsPanel.style.display = 'none';
            }

            // åˆ›å»ºè¡¨å¤´
            const headerRow = document.createElement('tr');
            data.columns.forEach(col => {
                const th = document.createElement('th');
                // ä½¿ç”¨ä¸­æ–‡åˆ—åï¼Œå¦‚æœæ˜ å°„ä¸­æ²¡æœ‰åˆ™ä½¿ç”¨åŸåˆ—å
                th.textContent = columnNameMap[col] || col;
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);

            // åˆ›å»ºè¡¨æ ¼å†…å®¹
            data.data.forEach(row => {
                const tr = document.createElement('tr');
                data.columns.forEach(col => {
                    const td = document.createElement('td');
                    const value = row[col];
                    // æ ¼å¼åŒ–æ˜¾ç¤ºå€¼
                    if (value !== null && value !== undefined) {
                        // å¦‚æœæ˜¯æ•°å­—ï¼Œæ·»åŠ åƒä½åˆ†éš”ç¬¦
                        if (typeof value === 'number' && !col.includes('DATE') && !col.includes('LINENO')) {
                            td.textContent = value.toLocaleString('zh-CN');
                        } else {
                            td.textContent = value;
                        }
                    } else {
                        td.textContent = '';
                    }
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });

            // æ˜¾ç¤ºç»“æœé¢æ¿
            resultsPanel.classList.add('show');
            
            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            resultsPanel.scrollIntoView({ behavior: 'smooth' });
        }

        function exportData() {
            if (!currentQueryData) {
                showError('è¯·å…ˆæŸ¥è¯¢æ•°æ®');
                return;
            }

            document.getElementById('exportBtn').disabled = true;
            document.getElementById('exportBtn').innerHTML = '<span>â³</span><span>å¯¼å‡ºä¸­...</span>';

            fetch('/export', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(currentQueryData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('å¯¼å‡ºå¤±è´¥');
                }
                return response.blob();
            })
            .then(blob => {
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `å®¢æµæ•°æ®_${currentQueryData.metric_type}_${currentQueryData.start_date}_${currentQueryData.end_date}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                // æ¢å¤æŒ‰é’®çŠ¶æ€
                document.getElementById('exportBtn').disabled = false;
                document.getElementById('exportBtn').innerHTML = '<span>ğŸ“¥</span><span>å¯¼å‡ºCSV</span>';
            })
            .catch(error => {
                showError('å¯¼å‡ºå¤±è´¥: ' + error.message);
                document.getElementById('exportBtn').disabled = false;
                document.getElementById('exportBtn').innerHTML = '<span>ğŸ“¥</span><span>å¯¼å‡ºCSV</span>';
            });
        }
        
        function calculateGrowthAuto() {
            const metricType = document.getElementById('metricType').value;
            const compareStartDate = document.getElementById('compareStartDate').value;
            const compareEndDate = document.getElementById('compareEndDate').value;
            const yearRange = parseInt(document.getElementById('yearRange').value);
            
            if (!compareStartDate || !compareEndDate) {
                showError('è¯·é€‰æ‹©è¦åˆ†æçš„æ—¥æœŸèŒƒå›´');
                return;
            }
            
            if (new Date(compareStartDate) > new Date(compareEndDate)) {
                showError('å¯¹æ¯”æœŸå¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†é«˜çº§å¤šå¹´é…ç½®
            const multiYearInputs = document.getElementById('multiYearInputs');
            const useCustomConfig = multiYearInputs && multiYearInputs.classList.contains('show') && yearRange > 0;
            
            let requestData = {
                metric_type: metricType
            };
            
            if (useCustomConfig) {
                // ä½¿ç”¨è‡ªå®šä¹‰çš„å¤šå¹´é…ç½®
                const yearConfigs = [];
                const currentYear = new Date(compareStartDate).getFullYear();
                
                for (let i = 0; i <= yearRange; i++) {
                    const year = currentYear - i;
                    const yearCompareStart = document.getElementById(`year${year}CompareStart`)?.value;
                    const yearCompareEnd = document.getElementById(`year${year}CompareEnd`)?.value;
                    const yearBaseStart = document.getElementById(`year${year}BaseStart`)?.value;
                    const yearBaseEnd = document.getElementById(`year${year}BaseEnd`)?.value;
                    
                    if (yearCompareStart && yearCompareEnd && yearBaseStart && yearBaseEnd) {
                        yearConfigs.push({
                            year: year,
                            compare_start: yearCompareStart,
                            compare_end: yearCompareEnd,
                            base_start: yearBaseStart,
                            base_end: yearBaseEnd
                        });
                    }
                }
                
                if (yearConfigs.length === 0) {
                    showError('æœªæ‰¾åˆ°æœ‰æ•ˆçš„å¹´ä»½é…ç½®');
                    return;
                }
                
                console.log('ä½¿ç”¨è‡ªå®šä¹‰å¤šå¹´é…ç½®:', yearConfigs);
                requestData.year_configs = yearConfigs;
                
                // ä½¿ç”¨å¤šå¹´é…ç½®API
                const apiUrl = '/calculate_growth_multi_year';
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const calculateBtn = document.getElementById('calculateGrowthBtn');
                const loading = document.getElementById('loading');
                calculateBtn.disabled = true;
                calculateBtn.innerHTML = '<span>â³</span><span>è®¡ç®—ä¸­...</span>';
                loading.classList.add('show');
                
                fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                })
                .then(response => {
                    console.log('æ”¶åˆ°å“åº”:', response);
                    return response.json();
                })
                .then(data => {
                    console.log('è§£æåçš„æ•°æ®:', data);
                    loading.classList.remove('show');
                    calculateBtn.disabled = false;
                    calculateBtn.innerHTML = '<span>ğŸ“Š</span><span>è®¡ç®—å¢é•¿ç‡</span>';
                    
                    if (data.success) {
                        // ä¿å­˜å½“å‰æŸ¥è¯¢é…ç½®ï¼Œç”¨äºå¯¼å‡º
                        currentGrowthData = {
                            metric_type: metricType,
                            year_configs: yearConfigs
                        };
                        
                        displayGrowthResults(data);
                        
                        // å¯ç”¨å¯¼å‡ºæŒ‰é’®
                        document.getElementById('exportGrowthBtn').disabled = false;
                    } else {
                        console.error('è®¡ç®—å¤±è´¥:', data.error);
                        showError(data.error || 'è®¡ç®—å¤±è´¥');
                    }
                })
                .catch(error => {
                    loading.classList.remove('show');
                    calculateBtn.disabled = false;
                    calculateBtn.innerHTML = '<span>ğŸ“Š</span><span>è®¡ç®—å¢é•¿ç‡</span>';
                    showError('ç½‘ç»œé”™è¯¯: ' + error.message);
                    console.error('è¯·æ±‚é”™è¯¯:', error);
                });
                
                return;
            }
            
            // ä½¿ç”¨é»˜è®¤é…ç½®ï¼ˆåŸæœ‰é€»è¾‘ï¼‰
            const baseStartDate = document.getElementById('baseStartDate').value;
            const baseEndDate = document.getElementById('baseEndDate').value;
            
            if (!baseStartDate || !baseEndDate) {
                showError('åŸºæœŸæ—¥æœŸè®¡ç®—å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            
            if (new Date(baseStartDate) > new Date(baseEndDate)) {
                showError('åŸºæœŸå¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
                return;
            }
            
            console.log('åŸºæœŸ:', baseStartDate, 'è‡³', baseEndDate);
            console.log('å¯¹æ¯”æœŸ:', compareStartDate, 'è‡³', compareEndDate);
            console.log('åŒæ¯”å¹´é™:', yearRange);
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const calculateBtn = document.getElementById('calculateGrowthBtn');
            const loading = document.getElementById('loading');
            calculateBtn.disabled = true;
            calculateBtn.innerHTML = '<span>â³</span><span>è®¡ç®—ä¸­...</span>';
            loading.classList.add('show');
            
            // å‘é€å¢é•¿ç‡è®¡ç®—è¯·æ±‚
            fetch('/calculate_growth', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    metric_type: metricType,
                    base_start_date: baseStartDate,
                    base_end_date: baseEndDate,
                    compare_start_date: compareStartDate,
                    compare_end_date: compareEndDate,
                    year_range: yearRange
                })
            })
            .then(response => {
                console.log('æ”¶åˆ°å“åº”:', response);
                return response.json();
            })
            .then(data => {
                console.log('è§£æåçš„æ•°æ®:', data);
                loading.classList.remove('show');
                calculateBtn.disabled = false;
                calculateBtn.innerHTML = '<span>ğŸ“Š</span><span>è®¡ç®—å¢é•¿ç‡</span>';
                
                if (data.success) {
                    // ä¿å­˜å½“å‰æŸ¥è¯¢é…ç½®ï¼Œç”¨äºå¯¼å‡º
                    currentGrowthData = {
                        metric_type: metricType,
                        base_start_date: baseStartDate,
                        base_end_date: baseEndDate,
                        compare_start_date: compareStartDate,
                        compare_end_date: compareEndDate,
                        year_range: yearRange
                    };
                    
                    displayGrowthResults(data);
                    
                    // å¯ç”¨å¯¼å‡ºæŒ‰é’®
                    document.getElementById('exportGrowthBtn').disabled = false;
                } else {
                    console.error('è®¡ç®—å¤±è´¥:', data.error);
                    showError(data.error || 'è®¡ç®—å¤±è´¥');
                }
            })
            .catch(error => {
                loading.classList.remove('show');
                calculateBtn.disabled = false;
                calculateBtn.innerHTML = '<span>ğŸ“Š</span><span>è®¡ç®—å¢é•¿ç‡</span>';
                showError('ç½‘ç»œé”™è¯¯: ' + error.message);
                console.error('è¯·æ±‚é”™è¯¯:', error);
            });
        }
        
        function exportGrowthData() {
            if (!currentGrowthData) {
                showError('è¯·å…ˆè®¡ç®—å¢é•¿ç‡');
                return;
            }
            
            const exportBtn = document.getElementById('exportGrowthBtn');
            exportBtn.disabled = true;
            exportBtn.innerHTML = '<span>â³</span><span>å¯¼å‡ºä¸­...</span>';
            
            fetch('/export_growth', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(currentGrowthData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('å¯¼å‡ºå¤±è´¥');
                }
                return response.blob();
            })
            .then(blob => {
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // ç”Ÿæˆæ–‡ä»¶å
                const compareStart = currentGrowthData.compare_start_date || '';
                const compareEnd = currentGrowthData.compare_end_date || '';
                const metricName = document.getElementById('metricType').selectedOptions[0].text;
                a.download = `å¢é•¿ç‡åˆ†æ_${metricName}_${compareStart}è‡³${compareEnd}.csv`;
                
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                exportBtn.disabled = false;
                exportBtn.innerHTML = '<span>ğŸ“¥</span><span>å¯¼å‡ºåˆ†æè¡¨æŠ¥</span>';
            })
            .catch(error => {
                showError('å¯¼å‡ºå¤±è´¥: ' + error.message);
                exportBtn.disabled = false;
                exportBtn.innerHTML = '<span>ğŸ“¥</span><span>å¯¼å‡ºåˆ†æè¡¨æŠ¥</span>';
            });
        }
        
        function displayGrowthResults(data) {
            console.log('æ˜¾ç¤ºå¢é•¿ç‡ç»“æœ:', data);
            
            const growthResultPanel = document.getElementById('growthResultPanel');
            const growthResultsContainer = document.getElementById('growthResultsContainer');
            const growthChartContainer = document.getElementById('growthChartContainer');
            
            // æ¸…ç©ºå®¹å™¨
            growthResultsContainer.innerHTML = '';
            
            // æ·»åŠ æ—¶æ®µè¯´æ˜
            const periodInfo = document.createElement('div');
            periodInfo.className = 'metric-info';
            periodInfo.style.marginBottom = '20px';
            
            let periodInfoHTML = `
                åŸºæœŸï¼š${data.base_period} ï¼ˆæ—¥å‡å€¼ä½œä¸ºåŸºå‡†ï¼‰<br>
                å¯¹æ¯”æœŸï¼š${data.compare_period} ï¼ˆæ¯å¤©ç›¸å¯¹åŸºæœŸæ—¥å‡çš„å¢é•¿ç‡ï¼‰
            `;
            
            if (data.year_range > 0) {
                const years = data.years_list || [];
                periodInfoHTML += `<br>åŒæ¯”å¹´ä»½ï¼š${years.join('ã€')}å¹´ ï¼ˆå…±${data.year_range}å¹´åŒæœŸå¯¹æ¯”ï¼‰`;
            }
            
            periodInfo.innerHTML = periodInfoHTML;
            growthResultsContainer.appendChild(periodInfo);
            
            // æ˜¾ç¤ºæ¯æ¡çº¿è·¯æ¯å¤©çš„å¢é•¿ç‡
            if (data.growth_data && data.growth_data.length > 0) {
                console.log('å¢é•¿ç‡æ•°æ®æ¡æ•°:', data.growth_data.length);
                
                // å¦‚æœæœ‰å¤šå¹´æ•°æ®ï¼Œç»˜åˆ¶æœ€å¤§å¢é•¿ç‡æ›²çº¿
                if (data.max_growth_by_day && data.max_growth_by_day.length > 0) {
                    try {
                        drawMaxGrowthChart(data.max_growth_by_day, data.metric_name);
                        document.getElementById('maxGrowthChartContainer').style.display = 'block';
                    } catch (error) {
                        console.error('ç»˜åˆ¶æœ€å¤§å¢é•¿ç‡å›¾è¡¨å¤±è´¥:', error);
                    }
                }
                
                // ç»˜åˆ¶å¢é•¿ç‡æ—¶é—´åºåˆ—å›¾è¡¨
                try {
                    drawGrowthTimeSeriesChart(data.growth_data, data.metric_name);
                    growthChartContainer.style.display = 'block';
                } catch (error) {
                    console.error('ç»˜åˆ¶å›¾è¡¨å¤±è´¥:', error);
                    growthChartContainer.style.display = 'none';
                }
                
                // æŒ‰çº¿è·¯å’Œå¹´ä»½åˆ†ç»„æ•°æ®
                const lineGroups = {};
                data.growth_data.forEach(item => {
                    const lineName = item['çº¿è·¯åç§°'] || 'æœªçŸ¥çº¿è·¯';
                    const year = item['å¹´ä»½'] || 'æœªçŸ¥å¹´ä»½';
                    
                    if (!lineGroups[lineName]) {
                        lineGroups[lineName] = {};
                    }
                    if (!lineGroups[lineName][year]) {
                        lineGroups[lineName][year] = [];
                    }
                    lineGroups[lineName][year].push(item);
                });
                
                // è·å–çº¿è·¯ç¼–å·å¹¶æ’åºï¼ˆçº¿ç½‘0ä¼˜å…ˆï¼‰
                const sortedLines = Object.keys(lineGroups).sort((a, b) => {
                    const getLineNo = (name) => {
                        const first = lineGroups[name][Object.keys(lineGroups[name])[0]][0];
                        return first['çº¿è·¯ç¼–å·'] || 999;
                    };
                    const aNo = getLineNo(a);
                    const bNo = getLineNo(b);
                    
                    // çº¿ç½‘(0)æ’ç¬¬ä¸€
                    if (aNo === 0) return -1;
                    if (bNo === 0) return 1;
                    return aNo - bNo;
                });
                
                // ä¸ºæ¯æ¡çº¿è·¯åˆ›å»ºä¸€ä¸ªå¡ç‰‡
                sortedLines.forEach((lineName, lineIndex) => {
                    const lineYearData = lineGroups[lineName];
                    const firstItem = Object.values(lineYearData)[0][0];
                    const lineNo = firstItem['çº¿è·¯ç¼–å·'] || 0;
                    const isNetwork = (lineNo === 0);
                    
                    // è®¡ç®—æ‰€æœ‰å¹´ä»½çš„æ€»å¹³å‡å¢é•¿ç‡
                    let totalDataCount = 0;
                    let totalGrowthSum = 0;
                    Object.values(lineYearData).forEach(yearData => {
                        yearData.forEach(item => {
                            totalGrowthSum += item['å¢é•¿ç‡'];
                            totalDataCount++;
                        });
                    });
                    const avgGrowth = totalDataCount > 0 ? totalGrowthSum / totalDataCount : 0;
                    const isPositive = avgGrowth >= 0;
                    
                    // æ‰¾å‡ºè¿™æ¡çº¿è·¯çš„æœ€å¤§å¢é•¿ç‡æ•°æ®
                    const lineMaxGrowth = data.max_growth_by_day ? 
                        data.max_growth_by_day.filter(item => item['çº¿è·¯ç¼–å·'] === lineNo) : [];
                    
                    const card = document.createElement('div');
                    card.className = `growth-card ${isPositive ? '' : 'negative'} ${isNetwork ? 'network' : ''}`;
                    
                    // åˆ›å»ºè¡¨æ ¼æ˜¾ç¤ºæ¯å¹´çš„æ•°æ®
                    let tableHTML = `
                        <div class="growth-card-header">
                            <div style="display: flex; align-items: center;">
                                <div class="growth-line-name">
                                    ${isNetwork ? 'ğŸŒ ' : ''}${lineName}${isNetwork ? 'ï¼ˆçº¿ç½‘æ€»ä½“ï¼‰' : ''}
                                </div>
                                ${!isNetwork ? `<button class="toggle-line-detail" onclick="toggleLineDetail(${lineIndex})">
                                    <span id="toggleIcon${lineIndex}">ğŸ‘ï¸</span>
                                    <span id="toggleText${lineIndex}">æŸ¥çœ‹è¯¦æƒ…</span>
                                </button>` : ''}
                            </div>
                            <div class="growth-rate ${isPositive ? 'positive' : 'negative'}">
                                æ€»å¹³å‡ ${isPositive ? 'â†‘' : 'â†“'} ${Math.abs(avgGrowth).toFixed(2)}%
                            </div>
                        </div>
                    `;
                    
                    // æ˜¾ç¤ºæœ€ä¼˜å¢é•¿ç‡æ‘˜è¦ï¼ˆå¦‚æœæœ‰å¤šå¹´æ•°æ®ï¼‰
                    if (lineMaxGrowth.length > 0) {
                        const maxOfMax = Math.max(...lineMaxGrowth.map(item => item['æœ€å¤§å¢é•¿ç‡']));
                        const avgMax = lineMaxGrowth.reduce((sum, item) => sum + item['æœ€å¤§å¢é•¿ç‡'], 0) / lineMaxGrowth.length;
                        
                        tableHTML += `
                            <div style="background: #fff9e6; padding: 12px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #ffc107;">
                                <div style="font-size: 13px; color: #666; margin-bottom: 5px;">ğŸ† å†å¹´æœ€ä¼˜è¡¨ç°</div>
                                <div style="display: flex; justify-content: space-around; text-align: center;">
                                    <div>
                                        <div style="font-size: 12px; color: #888;">å³°å€¼å¢é•¿ç‡</div>
                                        <div style="font-size: 18px; font-weight: 700; color: #ffc107;">${maxOfMax.toFixed(2)}%</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #888;">å¹³å‡æœ€ä¼˜</div>
                                        <div style="font-size: 18px; font-weight: 700; color: #ff9800;">${avgMax.toFixed(2)}%</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #888;">åŸºæœŸæ—¥å‡</div>
                                        <div style="font-size: 18px; font-weight: 700; color: #667eea;">${firstItem['åŸºæœŸæ—¥å‡'].toLocaleString('zh-CN')}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        tableHTML += `
                            <div style="margin-top: 15px; margin-bottom: 10px;">
                                <div style="font-size: 14px; color: #666;">
                                    åŸºæœŸæ—¥å‡ï¼š<strong style="color: #667eea;">${firstItem['åŸºæœŸæ—¥å‡'].toLocaleString('zh-CN')}</strong>
                                </div>
                            </div>
                        `;
                    }
                    
                    // è¯¦ç»†æ•°æ®åŒºåŸŸï¼ˆå¯æŠ˜å ï¼‰
                    tableHTML += `<div class="growth-card-content ${isNetwork ? '' : 'collapsed'}" id="lineContent${lineIndex}">`;
                    
                    // æ˜¾ç¤ºæœ€ä¼˜å¢é•¿ç‡è¯¦ç»†æ•°æ®ï¼ˆå¦‚æœæœ‰å¤šå¹´æ•°æ®ï¼‰
                    if (lineMaxGrowth.length > 0) {
                        tableHTML += `
                            <div style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: white; padding: 10px 15px; border-radius: 6px; margin-bottom: 15px; font-weight: 600; display: flex; justify-content: space-between; align-items: center;">
                                <span>ğŸ† å†å¹´æœ€ä¼˜å¢é•¿ç‡ï¼ˆæ¯å¤©çš„å†å²æœ€ä½³ï¼‰</span>
                            </div>
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; border: 2px solid #ffc107;">
                                <thead>
                                    <tr style="background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);">
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #ffc107;">ç¬¬å‡ å¤©</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #ffc107;">æœ€å¤§å¢é•¿ç‡</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #ffc107;">æ¥è‡ªå¹´ä»½</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #ffc107;">å½“æ—¥å®¢æµ</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        lineMaxGrowth.sort((a, b) => a['ç¬¬å‡ å¤©'] - b['ç¬¬å‡ å¤©']).forEach(item => {
                            const maxGrowth = item['æœ€å¤§å¢é•¿ç‡'];
                            const isPositive = maxGrowth >= 0;
                            const growthColor = isPositive ? '#48bb78' : '#f56565';
                            
                            tableHTML += `
                                <tr style="border-bottom: 1px solid #ffe8a1;">
                                    <td style="padding: 10px; text-align: center; font-weight: 600; background: #fff9e6;">ç¬¬${item['ç¬¬å‡ å¤©']}å¤©</td>
                                    <td style="padding: 10px; text-align: right; color: ${growthColor}; font-weight: 700; font-size: 16px;">
                                        ${isPositive ? 'â†‘' : 'â†“'} ${Math.abs(maxGrowth).toFixed(2)}%
                                    </td>
                                    <td style="padding: 10px; text-align: center; color: #667eea; font-weight: 600;">
                                        ${item['æœ€å¤§å€¼å¹´ä»½']}å¹´
                                    </td>
                                    <td style="padding: 10px; text-align: right; font-weight: 600;">
                                        ${item['æœ€å¤§å€¼å®¢æµ'].toLocaleString('zh-CN')}
                                    </td>
                                </tr>
                            `;
                        });
                        
                        tableHTML += `
                                </tbody>
                            </table>
                            <div style="border-top: 2px dashed #e0e0e0; margin: 20px 0; padding-top: 15px;">
                                <div style="color: #666; font-size: 13px; margin-bottom: 10px;">ğŸ“… å„å¹´åº¦è¯¦ç»†æ•°æ®</div>
                            </div>
                        `;
                    }
                    
                    // æŒ‰å¹´ä»½é™åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨ä¸Šé¢ï¼‰
                    const years = Object.keys(lineYearData).sort((a, b) => b - a);
                    
                    years.forEach((year, yearIndex) => {
                        const yearData = lineYearData[year];
                        const yearAvgGrowth = yearData.reduce((sum, item) => sum + item['å¢é•¿ç‡'], 0) / yearData.length;
                        const yearIsPositive = yearAvgGrowth >= 0;
                        
                        // å¹´ä»½æ ‡é¢˜ï¼ˆå¦‚æœæœ‰å¤šå¹´æ•°æ®ï¼‰
                        if (years.length > 1) {
                            tableHTML += `
                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 12px; border-radius: 6px; margin-top: ${yearIndex > 0 ? '15px' : '0'}; margin-bottom: 10px; font-weight: 600;">
                                    ${year}å¹´åŒæœŸ - å¹³å‡å¢é•¿ç‡: ${yearIsPositive ? 'â†‘' : 'â†“'} ${Math.abs(yearAvgGrowth).toFixed(2)}%
                                </div>
                            `;
                        }
                        
                        tableHTML += `
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 8px; text-align: left; border-bottom: 2px solid #e0e0e0;">æ—¥æœŸ</th>
                                        <th style="padding: 8px; text-align: right; border-bottom: 2px solid #e0e0e0;">å½“æ—¥å®¢æµ</th>
                                        <th style="padding: 8px; text-align: right; border-bottom: 2px solid #e0e0e0;">å¢é•¿é‡</th>
                                        <th style="padding: 8px; text-align: right; border-bottom: 2px solid #e0e0e0;">å¢é•¿ç‡</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        yearData.forEach(item => {
                            const dayGrowth = item['å¢é•¿ç‡'];
                            const dayPositive = dayGrowth >= 0;
                            const growthColor = dayPositive ? '#48bb78' : '#f56565';
                            
                            tableHTML += `
                                <tr style="border-bottom: 1px solid #f0f0f0;">
                                    <td style="padding: 8px;">${item['æ—¥æœŸ']}</td>
                                    <td style="padding: 8px; text-align: right;">${item['å½“æ—¥å®¢æµ'].toLocaleString('zh-CN')}</td>
                                    <td style="padding: 8px; text-align: right; color: ${growthColor}; font-weight: 600;">
                                        ${dayPositive ? '+' : ''}${item['å¢é•¿é‡'].toLocaleString('zh-CN')}
                                    </td>
                                    <td style="padding: 8px; text-align: right; color: ${growthColor}; font-weight: 600;">
                                        ${dayPositive ? 'â†‘' : 'â†“'} ${Math.abs(dayGrowth).toFixed(2)}%
                                    </td>
                                </tr>
                            `;
                        });
                        
                        tableHTML += `
                                </tbody>
                            </table>
                        `;
                    });
                    
                    tableHTML += `</div>`; // å…³é—­ growth-card-content
                    
                    card.innerHTML = tableHTML;
                    growthResultsContainer.appendChild(card);
                });
                
                growthResultPanel.classList.add('show');
                
                // æ»šåŠ¨åˆ°å¢é•¿ç‡ç»“æœ
                growthResultPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                showError('æ²¡æœ‰æ‰¾åˆ°å¯æ¯”è¾ƒçš„æ•°æ®');
            }
        }
        
        function drawMaxGrowthChart(maxGrowthData, metricName) {
            console.log('å¼€å§‹ç»˜åˆ¶æœ€å¤§å¢é•¿ç‡æ›²çº¿, æ•°æ®:', maxGrowthData);
            
            // æ£€æŸ¥Chart.jsæ˜¯å¦åŠ è½½
            if (typeof Chart === 'undefined') {
                console.error('Chart.js æœªåŠ è½½');
                return;
            }
            
            // é”€æ¯æ—§å›¾è¡¨
            if (maxGrowthChartInstance) {
                maxGrowthChartInstance.destroy();
            }
            
            // æŒ‰çº¿è·¯åˆ†ç»„
            const lineGroups = {};
            maxGrowthData.forEach(item => {
                const lineName = item['çº¿è·¯åç§°'] || 'æœªçŸ¥çº¿è·¯';
                if (!lineGroups[lineName]) {
                    lineGroups[lineName] = [];
                }
                lineGroups[lineName].push(item);
            });
            
            // å‡†å¤‡å›¾è¡¨æ•°æ®é›†
            const datasets = [];
            const colors = [
                { border: 'rgba(255, 99, 132, 1)', bg: 'rgba(255, 99, 132, 0.2)' },
                { border: 'rgba(54, 162, 235, 1)', bg: 'rgba(54, 162, 235, 0.2)' },
                { border: 'rgba(75, 192, 192, 1)', bg: 'rgba(75, 192, 192, 0.2)' },
                { border: 'rgba(255, 159, 64, 1)', bg: 'rgba(255, 159, 64, 0.2)' },
                { border: 'rgba(153, 102, 255, 1)', bg: 'rgba(153, 102, 255, 0.2)' },
            ];
            
            let colorIndex = 0;
            Object.keys(lineGroups).sort().forEach(lineName => {
                const lineData = lineGroups[lineName].sort((a, b) => a['ç¬¬å‡ å¤©'] - b['ç¬¬å‡ å¤©']);
                
                const maxGrowthRates = lineData.map(item => item['æœ€å¤§å¢é•¿ç‡']);
                const dayLabels = lineData.map(item => `ç¬¬${item['ç¬¬å‡ å¤©']}å¤©`);
                
                // ä¸ºå·¥å…·æç¤ºå‡†å¤‡é¢å¤–ä¿¡æ¯
                const metadata = lineData.map(item => ({
                    year: item['æœ€å¤§å€¼å¹´ä»½'],
                    date: item['æœ€å¤§å€¼æ—¥æœŸ'],
                    flow: item['æœ€å¤§å€¼å®¢æµ']
                }));
                
                const color = colors[colorIndex % colors.length];
                colorIndex++;
                
                datasets.push({
                    label: lineName,
                    data: maxGrowthRates,
                    borderColor: color.border,
                    backgroundColor: color.bg,
                    borderWidth: 4,
                    pointRadius: 7,
                    pointHoverRadius: 10,
                    pointBackgroundColor: color.border,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    metadata: metadata  // ä¿å­˜å…ƒæ•°æ®
                });
            });
            
            // è·å–Xè½´æ ‡ç­¾ï¼ˆç¬¬1å¤©ã€ç¬¬2å¤©...ï¼‰
            const maxDays = Math.max(...maxGrowthData.map(item => item['ç¬¬å‡ å¤©']));
            const dayLabels = Array.from({length: maxDays}, (_, i) => `ç¬¬${i + 1}å¤©`);
            
            // åˆ›å»ºå›¾è¡¨
            const ctx = document.getElementById('maxGrowthChart').getContext('2d');
            maxGrowthChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dayLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `ğŸ† ${metricName}å†å¹´æœ€ä¼˜è¡¨ç°æ›²çº¿`,
                            font: {
                                size: 20,
                                weight: 'bold'
                            },
                            padding: 20,
                            color: '#667eea'
                        },
                        subtitle: {
                            display: true,
                            text: 'æ¯å¤©æ˜¾ç¤ºå†å¹´ä¸­å¢é•¿ç‡æœ€é«˜çš„æ•°å€¼',
                            font: {
                                size: 14
                            },
                            padding: 10,
                            color: '#666'
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 13
                                },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            padding: 15,
                            titleFont: {
                                size: 15,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function(context) {
                                    const datasetIndex = context.datasetIndex;
                                    const dataIndex = context.dataIndex;
                                    const dataset = context.chart.data.datasets[datasetIndex];
                                    const meta = dataset.metadata[dataIndex];
                                    
                                    return [
                                        `${dataset.label}`,
                                        `æœ€å¤§å¢é•¿ç‡: ${context.parsed.y.toFixed(2)}%`,
                                        `æ¥è‡ª: ${meta.year}å¹´ (${meta.date})`,
                                        `å½“æ—¥å®¢æµ: ${meta.flow.toLocaleString('zh-CN')}`
                                    ];
                                },
                                title: function(context) {
                                    return context[0].label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'å¢é•¿ç‡ (%)',
                                font: {
                                    size: 15,
                                    weight: 'bold'
                                },
                                color: '#667eea'
                            },
                            grid: {
                                color: 'rgba(102, 126, 234, 0.1)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                },
                                font: {
                                    size: 12
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'å¯¹æ¯”æœŸï¼ˆæŒ‰å¤©æ•°è®¡ï¼‰',
                                font: {
                                    size: 15,
                                    weight: 'bold'
                                },
                                color: '#667eea'
                            },
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
            
            console.log('æœ€å¤§å¢é•¿ç‡æ›²çº¿åˆ›å»ºæˆåŠŸ');
        }
        
        function drawGrowthTimeSeriesChart(growthData, metricName) {
            console.log('å¼€å§‹ç»˜åˆ¶æ—¶é—´åºåˆ—å›¾è¡¨, æ•°æ®:', growthData);
            
            // æ£€æŸ¥Chart.jsæ˜¯å¦åŠ è½½
            if (typeof Chart === 'undefined') {
                console.error('Chart.js æœªåŠ è½½');
                alert('å›¾è¡¨åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            
            // é”€æ¯æ—§å›¾è¡¨
            if (growthChartInstance) {
                growthChartInstance.destroy();
            }
            
            // æŒ‰çº¿è·¯å’Œå¹´ä»½åˆ†ç»„
            const lineYearGroups = {};
            growthData.forEach(item => {
                const lineName = item['çº¿è·¯åç§°'] || 'æœªçŸ¥çº¿è·¯';
                const year = item['å¹´ä»½'] || 'æœªçŸ¥';
                const key = `${lineName} (${year}å¹´)`;
                
                if (!lineYearGroups[key]) {
                    lineYearGroups[key] = {
                        lineName: lineName,
                        year: year,
                        data: []
                    };
                }
                lineYearGroups[key].data.push(item);
            });
            
            // è·å–æ‰€æœ‰æ—¥æœŸï¼ˆä»…æœˆ-æ—¥éƒ¨åˆ†ï¼Œç”¨äºXè½´ï¼‰
            const dates = [...new Set(growthData.map(item => item['æ—¥æœŸ'].substring(4)))].sort(); // MMDDæ ¼å¼
            
            // æ ¼å¼åŒ–æ—¥æœŸä¸º MM-DD
            const formatDateLabel = (mmdd) => {
                return `${mmdd.substring(0, 2)}-${mmdd.substring(2, 4)}`;
            };
            
            const dateLabels = dates.map(formatDateLabel);
            
            // ä¸ºæ¯æ¡çº¿è·¯çš„æ¯å¹´åˆ›å»ºæ•°æ®é›†
            const datasets = [];
            const baseColors = [
                { border: 'rgba(102, 126, 234, 1)', bg: 'rgba(102, 126, 234, 0.1)' },
                { border: 'rgba(255, 159, 64, 1)', bg: 'rgba(255, 159, 64, 0.1)' },
                { border: 'rgba(72, 187, 120, 1)', bg: 'rgba(72, 187, 120, 0.1)' },
                { border: 'rgba(245, 101, 101, 1)', bg: 'rgba(245, 101, 101, 0.1)' },
                { border: 'rgba(153, 102, 255, 1)', bg: 'rgba(153, 102, 255, 0.1)' },
            ];
            
            // çº¿å‹æ ·å¼ï¼ˆç”¨äºåŒºåˆ†å¹´ä»½ï¼‰
            const lineStyles = [
                { width: 4, dash: [] },           // å®çº¿ï¼ˆå½“å¹´ï¼‰
                { width: 3, dash: [5, 5] },       // çŸ­è™šçº¿
                { width: 3, dash: [10, 5] },      // é•¿è™šçº¿
                { width: 2, dash: [2, 2] },       // ç‚¹çº¿
                { width: 2, dash: [10, 5, 2, 5] } // ç‚¹åˆ’çº¿
            ];
            
            let colorIndex = 0;
            Object.keys(lineYearGroups).sort().forEach(key => {
                const group = lineYearGroups[key];
                const growthRates = dates.map(mmdd => {
                    const item = group.data.find(d => d['æ—¥æœŸ'].substring(4) === mmdd);
                    return item ? item['å¢é•¿ç‡'] : null;
                });
                
                // è·å–åŸºç¡€é¢œè‰²
                const baseColor = baseColors[colorIndex % baseColors.length];
                
                // æ ¹æ®å¹´ä»½é€‰æ‹©çº¿å‹ï¼ˆæœ€æ–°å¹´ä»½ç”¨å®çº¿ï¼‰
                const years = [...new Set(growthData.map(item => item['å¹´ä»½']))].sort((a, b) => b - a);
                const yearIndex = years.indexOf(group.year);
                const lineStyle = lineStyles[yearIndex % lineStyles.length];
                
                datasets.push({
                    label: key,
                    data: growthRates,
                    borderColor: baseColor.border,
                    backgroundColor: baseColor.bg,
                    borderWidth: lineStyle.width,
                    borderDash: lineStyle.dash,
                    pointRadius: yearIndex === 0 ? 6 : 4, // å½“å¹´çš„ç‚¹æ›´å¤§
                    pointHoverRadius: 8,
                    tension: 0.4,
                    fill: yearIndex === 0 // åªæœ‰å½“å¹´å¡«å……èƒŒæ™¯
                });
                
                // åŒä¸€çº¿è·¯çš„ä¸åŒå¹´ä»½ç”¨ç›¸åŒé¢œè‰²
                if (group.data.length > 0 && group.data[group.data.length - 1]['æ—¥æœŸ'].substring(4) === dates[dates.length - 1]) {
                    colorIndex++;
                }
            });
            
            // åˆ›å»ºå›¾è¡¨
            const ctx = document.getElementById('growthChart').getContext('2d');
            growthChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dateLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `${metricName}å¢é•¿ç‡å¤šå¹´åŒæœŸå¯¹æ¯”ï¼ˆç›¸å¯¹åŸºæœŸæ—¥å‡ï¼‰`,
                            font: {
                                size: 18,
                                weight: 'bold'
                            },
                            padding: 20
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 13
                                },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.parsed.y;
                                    if (value !== null) {
                                        label += (value >= 0 ? 'â†‘ +' : 'â†“ ') + value.toFixed(2) + '%';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'å¢é•¿ç‡ (%)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
            
            console.log('æ—¶é—´åºåˆ—å›¾è¡¨åˆ›å»ºæˆåŠŸ');
        }
        
        function drawGrowthChart(growthData, metricName) {
            console.log('å¼€å§‹ç»˜åˆ¶å›¾è¡¨, æ•°æ®:', growthData);
            
            // æ£€æŸ¥Chart.jsæ˜¯å¦åŠ è½½
            if (typeof Chart === 'undefined') {
                console.error('Chart.js æœªåŠ è½½');
                alert('å›¾è¡¨åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            
            // é”€æ¯æ—§å›¾è¡¨
            if (growthChartInstance) {
                growthChartInstance.destroy();
            }
            
            // å‡†å¤‡å›¾è¡¨æ•°æ®
            const labels = growthData.map(item => item.F_LINENAME || 'æœªçŸ¥çº¿è·¯');
            const growthRates = growthData.map(item => item['å¢é•¿ç‡']);
            const baseAverages = growthData.map(item => item['åŸºæœŸå¹³å‡']);
            const compareAverages = growthData.map(item => item['å¯¹æ¯”æœŸå¹³å‡']);
            
            console.log('å›¾è¡¨æ ‡ç­¾:', labels);
            console.log('å¢é•¿ç‡:', growthRates);
            
            // æ ¹æ®å¢é•¿ç‡è®¾ç½®é¢œè‰²
            const backgroundColor = growthRates.map(rate => 
                rate >= 0 ? 'rgba(72, 187, 120, 0.6)' : 'rgba(245, 101, 101, 0.6)'
            );
            const borderColor = growthRates.map(rate => 
                rate >= 0 ? 'rgba(72, 187, 120, 1)' : 'rgba(245, 101, 101, 1)'
            );
            
            // åˆ›å»ºå›¾è¡¨
            const ctx = document.getElementById('growthChart').getContext('2d');
            growthChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å¢é•¿ç‡ (%)',
                        data: growthRates,
                        backgroundColor: backgroundColor,
                        borderColor: borderColor,
                        borderWidth: 2,
                        yAxisID: 'y-rate'
                    }, {
                        label: 'åŸºæœŸå¹³å‡',
                        data: baseAverages,
                        type: 'line',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        yAxisID: 'y-value',
                        tension: 0.4
                    }, {
                        label: 'å¯¹æ¯”æœŸå¹³å‡',
                        data: compareAverages,
                        type: 'line',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        backgroundColor: 'rgba(255, 159, 64, 0.1)',
                        borderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        yAxisID: 'y-value',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `${metricName}å¢é•¿ç‡åˆ†æ`,
                            font: {
                                size: 18,
                                weight: 'bold'
                            },
                            padding: 20
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12
                                },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.datasetIndex === 0) {
                                        // å¢é•¿ç‡
                                        label += context.parsed.y.toFixed(2) + '%';
                                    } else {
                                        // å¹³å‡å€¼
                                        label += context.parsed.y.toLocaleString('zh-CN');
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        'y-rate': {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'å¢é•¿ç‡ (%)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                drawOnChartArea: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        },
                        'y-value': {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: metricName,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('zh-CN');
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
            
            console.log('å›¾è¡¨åˆ›å»ºæˆåŠŸ');
        }
        
        // ============ é¢„æµ‹åŠŸèƒ½ ============
        
        // è®¾ç½®é¢„æµ‹æ—¥æœŸçš„é»˜è®¤å€¼
        const predictStartInput = document.getElementById('predictStartDate');
        const predictEndInput = document.getElementById('predictEndDate');
        if (predictStartInput && predictEndInput) {
            // é»˜è®¤é¢„æµ‹æœ¬æœˆ1å·å¼€å§‹çš„5å¤©ï¼ˆè¿™æ ·å¯ä»¥å’Œå®é™…æ•°æ®å¯¹æ¯”ï¼‰
            const today = new Date();
            const thisMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            predictStartInput.valueAsDate = thisMonthStart;
            
            const defaultEndDate = new Date(thisMonthStart);
            defaultEndDate.setDate(defaultEndDate.getDate() + 4);
            predictEndInput.valueAsDate = defaultEndDate;
            
            // åˆå§‹åŒ–åŸºæœŸæ˜¾ç¤º
            updatePredictBasePeriod();
            updatePredictMultiYearConfig();
        }
        
        // ç›‘å¬é¢„æµ‹å¼€å§‹æ—¥æœŸå˜åŒ–ï¼Œè‡ªåŠ¨è®¾ç½®ç»“æŸæ—¥æœŸ
        document.getElementById('predictStartDate')?.addEventListener('change', function() {
            const startDate = this.valueAsDate;
            if (startDate) {
                // é»˜è®¤è®¾ç½®ä¸º5å¤©å
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 4);
                const endDateInput = document.getElementById('predictEndDate');
                endDateInput.valueAsDate = endDate;
                
                // æ·»åŠ é«˜äº®åŠ¨ç”»æ•ˆæœ
                endDateInput.classList.add('auto-filled');
                setTimeout(() => {
                    endDateInput.classList.remove('auto-filled');
                }, 800);
            }
            
            updatePredictBasePeriod();
            updatePredictMultiYearConfig();
            // æ—¥æœŸå˜åŒ–æ—¶è‡ªåŠ¨æ£€æŸ¥æ•°æ®å¯ç”¨æ€§
            checkPredictDataAvailability();
        });
        
        document.getElementById('predictEndDate')?.addEventListener('change', function() {
            updatePredictBasePeriod();
            updatePredictMultiYearConfig();
            // æ—¥æœŸå˜åŒ–æ—¶è‡ªåŠ¨æ£€æŸ¥æ•°æ®å¯ç”¨æ€§
            checkPredictDataAvailability();
        });
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡
        if (predictStartInput && predictEndInput && predictStartInput.value && predictEndInput.value) {
            checkPredictDataAvailability();
        }
        
        function checkPredictDataAvailability() {
            const metricType = document.getElementById('predictMetricType').value;
            const startDate = document.getElementById('predictStartDate').value;
            const endDate = document.getElementById('predictEndDate').value;
            
            if (!startDate || !endDate) {
                document.getElementById('predictDataCheck').style.display = 'none';
                return;
            }
            
            const checkDiv = document.getElementById('predictDataCheck');
            const iconDiv = document.getElementById('predictDataCheckIcon');
            const textDiv = document.getElementById('predictDataCheckText');
            
            // æ˜¾ç¤ºæ£€æŸ¥ä¸­çŠ¶æ€
            checkDiv.style.display = 'block';
            checkDiv.style.background = '#f7fafc';
            checkDiv.style.border = '1px solid #e2e8f0';
            iconDiv.textContent = 'â³';
            textDiv.innerHTML = '<span style="color: #666;">æ­£åœ¨æ£€æŸ¥æ•°æ®å¯ç”¨æ€§...</span>';
            
            fetch('/check_data_availability', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    metric_type: metricType,
                    start_date: startDate,
                    end_date: endDate
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.has_data) {
                        // æœ‰æ•°æ®
                        checkDiv.style.background = '#f0fdf4';
                        checkDiv.style.border = '1px solid #86efac';
                        iconDiv.textContent = 'âœ…';
                        textDiv.innerHTML = `<strong style="color: #16a34a;">${data.message}</strong>`;
                    } else {
                        // æ— æ•°æ®
                        checkDiv.style.background = '#fff7ed';
                        checkDiv.style.border = '1px solid #fdba74';
                        iconDiv.textContent = 'âš ï¸';
                        textDiv.innerHTML = `<span style="color: #ea580c;">${data.message}</span>`;
                    }
                } else {
                    checkDiv.style.background = '#fef2f2';
                    checkDiv.style.border = '1px solid #fca5a5';
                    iconDiv.textContent = 'âŒ';
                    textDiv.innerHTML = `<span style="color: #dc2626;">æ£€æŸ¥å¤±è´¥ï¼š${data.error}</span>`;
                }
            })
            .catch(error => {
                checkDiv.style.background = '#fef2f2';
                checkDiv.style.border = '1px solid #fca5a5';
                iconDiv.textContent = 'âŒ';
                textDiv.innerHTML = `<span style="color: #dc2626;">æ£€æŸ¥å¤±è´¥ï¼š${error.message}</span>`;
            });
        }
        
        function togglePredictMultiYearConfig() {
            const inputs = document.getElementById('predictMultiYearInputs');
            const icon = document.getElementById('predictMultiYearExpandIcon');
            
            if (inputs.classList.contains('show')) {
                inputs.classList.remove('show');
                icon.classList.remove('expanded');
            } else {
                inputs.classList.add('show');
                icon.classList.add('expanded');
            }
        }
        
        function updatePredictMultiYearConfig() {
            const historyYears = parseInt(document.getElementById('historyYears').value);
            const section = document.getElementById('predictMultiYearSection');
            const container = document.getElementById('predictYearConfigContainer');
            
            if (historyYears === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            container.innerHTML = '';
            
            const predictStart = document.getElementById('predictStartDate').value;
            const predictEnd = document.getElementById('predictEndDate').value;
            
            if (!predictStart || !predictEnd) {
                container.innerHTML = '<div class="metric-info">è¯·å…ˆé€‰æ‹©é¢„æµ‹æ—¥æœŸ</div>';
                return;
            }
            
            const predictYear = new Date(predictStart).getFullYear();
            const predictMonth = new Date(predictStart).getMonth();
            
            // ä¸ºæ¯ä¸ªå†å²å¹´ä»½ç”Ÿæˆé…ç½®
            for (let i = 1; i <= historyYears; i++) {
                const historyYear = predictYear - i;
                
                // å‚è€ƒæœŸï¼ˆåŒæœŸæ—¥æœŸï¼‰
                const refStart = predictStart.replace(/^\d{4}/, historyYear);
                const refEnd = predictEnd.replace(/^\d{4}/, historyYear);
                
                // åŸºæœŸï¼ˆè¯¥å¹´çš„ä¸Šæœˆï¼‰
                let baseMonth = predictMonth - 1;
                let baseYear = historyYear;
                if (baseMonth < 0) {
                    baseMonth = 11;
                    baseYear--;
                }
                
                const baseStart = new Date(baseYear, baseMonth, 1);
                const baseEnd = new Date(baseYear, baseMonth + 1, 0);
                const historyBaseStart = formatDateLocal(baseStart);
                const historyBaseEnd = formatDateLocal(baseEnd);
                
                const yearConfig = document.createElement('div');
                yearConfig.className = 'year-config-item';
                yearConfig.innerHTML = `
                    <div class="year-label">${historyYear}å¹´å‚è€ƒæ•°æ®ï¼ˆå‰${i}å¹´ï¼‰</div>
                    <div class="date-range">
                        <div class="form-group">
                            <label for="predictYear${historyYear}RefStart">å‚è€ƒæœŸå¼€å§‹</label>
                            <input type="date" id="predictYear${historyYear}RefStart" value="${refStart}">
                        </div>
                        <div class="form-group">
                            <label for="predictYear${historyYear}RefEnd">å‚è€ƒæœŸç»“æŸ</label>
                            <input type="date" id="predictYear${historyYear}RefEnd" value="${refEnd}">
                        </div>
                    </div>
                    <div class="date-range" style="margin-top: 10px;">
                        <div class="form-group">
                            <label for="predictYear${historyYear}BaseStart">åŸºæœŸå¼€å§‹</label>
                            <input type="date" id="predictYear${historyYear}BaseStart" value="${historyBaseStart}">
                        </div>
                        <div class="form-group">
                            <label for="predictYear${historyYear}BaseEnd">åŸºæœŸç»“æŸ</label>
                            <input type="date" id="predictYear${historyYear}BaseEnd" value="${historyBaseEnd}">
                        </div>
                    </div>
                `;
                container.appendChild(yearConfig);
            }
        }
        
        function updatePredictBasePeriod() {
            const predictStart = document.getElementById('predictStartDate').value;
            const displayElement = document.getElementById('predictBasePeriodDisplay');
            
            if (!predictStart) {
                displayElement.textContent = 'è¯·å…ˆé€‰æ‹©é¢„æµ‹æ—¥æœŸ';
                return;
            }
            
            const predictDate = new Date(predictStart);
            const predictYear = predictDate.getFullYear();
            const predictMonth = predictDate.getMonth();
            
            let baseMonth = predictMonth - 1;
            let baseYear = predictYear;
            if (baseMonth < 0) {
                baseMonth = 11;
                baseYear--;
            }
            
            const baseStart = new Date(baseYear, baseMonth, 1);
            const baseEnd = new Date(baseYear, baseMonth + 1, 0);
            const baseStartDate = formatDateLocal(baseStart);
            const baseEndDate = formatDateLocal(baseEnd);
            const days = baseEnd.getDate();
            
            const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
            displayElement.textContent = `${baseStartDate} è‡³ ${baseEndDate} ï¼ˆ${baseYear}å¹´${monthNames[baseMonth]}ï¼Œå…±${days}å¤©ï¼‰`;
        }
        
        function predictFlow() {
            const metricType = document.getElementById('predictMetricType').value;
            const predictStart = document.getElementById('predictStartDate').value;
            const predictEnd = document.getElementById('predictEndDate').value;
            const historyYears = parseInt(document.getElementById('historyYears').value);
            
            if (!predictStart || !predictEnd) {
                showPredictError('è¯·é€‰æ‹©é¢„æµ‹æ—¥æœŸèŒƒå›´');
                return;
            }
            
            if (new Date(predictStart) > new Date(predictEnd)) {
                showPredictError('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨è‡ªå®šä¹‰é…ç½®
            let customConfigs = null;
            const inputs = document.getElementById('predictMultiYearInputs');
            if (inputs && inputs.classList.contains('show')) {
                customConfigs = {};
                const predictYear = new Date(predictStart).getFullYear();
                
                for (let i = 1; i <= historyYears; i++) {
                    const historyYear = predictYear - i;
                    const refStart = document.getElementById(`predictYear${historyYear}RefStart`);
                    const refEnd = document.getElementById(`predictYear${historyYear}RefEnd`);
                    const baseStart = document.getElementById(`predictYear${historyYear}BaseStart`);
                    const baseEnd = document.getElementById(`predictYear${historyYear}BaseEnd`);
                    
                    if (refStart && refEnd && baseStart && baseEnd) {
                        customConfigs[historyYear] = {
                            ref_start: refStart.value,
                            ref_end: refEnd.value,
                            base_start: baseStart.value,
                            base_end: baseEnd.value
                        };
                    }
                }
            }
            
            const predictBtn = document.getElementById('predictBtn');
            const loading = document.getElementById('predictLoading');
            
            predictBtn.disabled = true;
            predictBtn.innerHTML = '<span>â³</span><span>é¢„æµ‹ä¸­...</span>';
            loading.classList.add('show');
            
            const requestData = {
                metric_type: metricType,
                predict_start: predictStart,
                predict_end: predictEnd,
                history_years: historyYears
            };
            
            if (customConfigs && Object.keys(customConfigs).length > 0) {
                requestData.custom_configs = customConfigs;
            }
            
            fetch('/predict_flow', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                loading.classList.remove('show');
                predictBtn.disabled = false;
                predictBtn.innerHTML = '<span>ğŸ”®</span><span>å¼€å§‹é¢„æµ‹</span>';
                
                if (data.success) {
                    displayPredictResults(data);
                } else {
                    showPredictError(data.error || 'é¢„æµ‹å¤±è´¥');
                }
            })
            .catch(error => {
                loading.classList.remove('show');
                predictBtn.disabled = false;
                predictBtn.innerHTML = '<span>ğŸ”®</span><span>å¼€å§‹é¢„æµ‹</span>';
                showPredictError('ç½‘ç»œé”™è¯¯: ' + error.message);
            });
        }
        
        function showPredictError(message) {
            const errorDiv = document.getElementById('predictErrorMessage');
            errorDiv.textContent = 'âŒ ' + message;
            errorDiv.classList.add('show');
            setTimeout(() => {
                errorDiv.classList.remove('show');
            }, 5000);
        }
        
        function togglePredictDetails() {
            const content = document.getElementById('predictDetailsContent');
            const icon = document.getElementById('predictDetailsExpandIcon');
            
            if (content && icon) {
                if (content.classList.contains('show')) {
                    content.classList.remove('show');
                    icon.classList.remove('expanded');
                } else {
                    content.classList.add('show');
                    icon.classList.add('expanded');
                }
            }
        }
        
        function displayPredictResults(data) {
            console.log('æ˜¾ç¤ºé¢„æµ‹ç»“æœ:', data);
            console.log('has_actual =', data.has_actual);
            console.log('predictions æ€»æ•° =', data.predictions.length);
            
            // ç»Ÿè®¡æœ‰å‡†ç¡®ç‡çš„è®°å½•
            const withAccuracy = data.predictions.filter(p => p['å‡†ç¡®ç‡'] !== null && p['å‡†ç¡®ç‡'] !== undefined);
            console.log('æœ‰å‡†ç¡®ç‡çš„è®°å½•æ•° =', withAccuracy.length);
            if (withAccuracy.length > 0) {
                console.log('ç¬¬ä¸€æ¡æœ‰å‡†ç¡®ç‡çš„è®°å½•:', withAccuracy[0]);
            }
            
            const resultsPanel = document.getElementById('predictResultsPanel');
            const recordCount = document.getElementById('predictRecordCount');
            const accuracyPanel = document.getElementById('predictAccuracyPanel');
            const accuracyGrid = document.getElementById('predictAccuracyGrid');
            const dataContainer = document.getElementById('predictDataContainer');
            
            // æ¸…ç©ºå®¹å™¨
            dataContainer.innerHTML = '';
            accuracyGrid.innerHTML = '';
            
            // æ˜¾ç¤ºè®°å½•æ•°
            recordCount.textContent = `${data.predictions.length} æ¡é¢„æµ‹`;
            
            // æ·»åŠ è¯´æ˜ä¿¡æ¯
            const infoDiv = document.createElement('div');
            infoDiv.className = 'metric-info';
            infoDiv.style.marginBottom = '20px';
            infoDiv.innerHTML = `
                é¢„æµ‹æ—¥æœŸï¼š${data.predict_period}<br>
                å‚è€ƒå†å²ï¼šå‰${data.history_years}å¹´åŒæœŸæœ€ä¼˜å¢é•¿ç‡
                ${data.has_actual ? '<br><strong style="color: #48bb78;">âœ“ å·²æ‰¾åˆ°å®é™…æ•°æ®ï¼Œå‡†ç¡®ç‡å¯¹æ¯”å¦‚ä¸‹</strong>' : '<br><strong style="color: #ff9800;">âš  æš‚æ— å®é™…æ•°æ®ï¼Œä»…æ˜¾ç¤ºé¢„æµ‹å€¼</strong>'}
            `;
            dataContainer.appendChild(infoDiv);
            
            // æ·»åŠ "æŸ¥çœ‹è®¡ç®—è¿‡ç¨‹"å±•å¼€åŒºåŸŸ
            if (data.history_details && data.history_details.length > 0) {
                const detailsSection = document.createElement('div');
                detailsSection.className = 'multi-year-section';
                detailsSection.style.marginBottom = '20px';
                
                const detailsHeader = document.createElement('div');
                detailsHeader.className = 'multi-year-header';
                detailsHeader.onclick = function() { togglePredictDetails(); };
                detailsHeader.innerHTML = `
                    <div class="multi-year-title">
                        <span>ğŸ”</span>
                        <span>æŸ¥çœ‹è®¡ç®—è¿‡ç¨‹ï¼ˆå†å¹´æ•°æ®è¯¦æƒ…ï¼‰</span>
                    </div>
                    <div class="expand-icon" id="predictDetailsExpandIcon">ğŸ”½</div>
                `;
                detailsSection.appendChild(detailsHeader);
                
                const detailsContent = document.createElement('div');
                detailsContent.className = 'multi-year-inputs';
                detailsContent.id = 'predictDetailsContent';
                
                // ä¸ºæ¯ä¸€å¹´ç”Ÿæˆè¯¦æƒ…
                data.history_details.forEach(yearDetail => {
                    const yearDiv = document.createElement('div');
                    yearDiv.className = 'year-config-item';
                    yearDiv.style.marginBottom = '15px';
                    
                    let html = `
                        <div class="year-label">${yearDetail.year}å¹´å†å²æ•°æ®</div>
                        <div class="metric-info" style="margin: 10px 0;">
                            å‚è€ƒæœŸï¼š${yearDetail.ref_period}<br>
                            åŸºæœŸï¼š${yearDetail.base_period}
                        </div>
                    `;
                    
                    if (yearDetail.line_stats && yearDetail.line_stats.length > 0) {
                        html += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: 13px;">';
                        html += '<thead><tr style="background-color: #f7fafc;">';
                        html += '<th style="padding: 8px; text-align: left; border: 1px solid #e2e8f0;">çº¿è·¯</th>';
                        html += '<th style="padding: 8px; text-align: right; border: 1px solid #e2e8f0;">åŸºæœŸæ—¥å‡</th>';
                        html += '<th style="padding: 8px; text-align: right; border: 1px solid #e2e8f0;">å¹³å‡å¢é•¿ç‡</th>';
                        html += '<th style="padding: 8px; text-align: right; border: 1px solid #e2e8f0;">æœ€å¤§å¢é•¿ç‡</th>';
                        html += '</tr></thead><tbody>';
                        
                        yearDetail.line_stats.forEach(stat => {
                            const avgColor = stat.avg_growth >= 0 ? '#48bb78' : '#f56565';
                            const maxColor = stat.max_growth >= 0 ? '#48bb78' : '#f56565';
                            html += `<tr>
                                <td style="padding: 8px; border: 1px solid #e2e8f0;">${stat.line_name}</td>
                                <td style="padding: 8px; text-align: right; border: 1px solid #e2e8f0;">${stat.base_avg.toLocaleString()}</td>
                                <td style="padding: 8px; text-align: right; border: 1px solid #e2e8f0; color: ${avgColor}; font-weight: 600;">${stat.avg_growth.toFixed(2)}%</td>
                                <td style="padding: 8px; text-align: right; border: 1px solid #e2e8f0; color: ${maxColor}; font-weight: 600;">${stat.max_growth.toFixed(2)}%</td>
                            </tr>`;
                        });
                        
                        html += '</tbody></table></div>';
                    }
                    
                    yearDiv.innerHTML = html;
                    detailsContent.appendChild(yearDiv);
                });
                
                detailsSection.appendChild(detailsContent);
                dataContainer.appendChild(detailsSection);
            }
            
            // å¦‚æœæœ‰å®é™…æ•°æ®ï¼Œæ˜¾ç¤ºå‡†ç¡®ç‡ç»Ÿè®¡
            if (data.has_actual) {
                const predictions = data.predictions.filter(p => p['å‡†ç¡®ç‡'] !== null);
                if (predictions.length > 0) {
                    const avgAccuracy = predictions.reduce((sum, p) => sum + p['å‡†ç¡®ç‡'], 0) / predictions.length;
                    
                    // æŒ‰çº¿è·¯åˆ†ç»„ç»Ÿè®¡å‡†ç¡®ç‡
                    const lineAccuracy = {};
                    predictions.forEach(p => {
                        const lineName = p['çº¿è·¯åç§°'];
                        if (!lineAccuracy[lineName]) {
                            lineAccuracy[lineName] = { sum: 0, count: 0 };
                        }
                        lineAccuracy[lineName].sum += p['å‡†ç¡®ç‡'];
                        lineAccuracy[lineName].count++;
                    });
                    
                    // æ˜¾ç¤ºæ€»ä½“å‡†ç¡®ç‡
                    const overallCard = document.createElement('div');
                    overallCard.className = 'stat-card';
                    overallCard.style.borderLeftColor = '#48bb78';
                    overallCard.innerHTML = `
                        <div style="font-weight: 600; color: #48bb78; margin-bottom: 8px; font-size: 16px;">æ€»ä½“å¹³å‡å‡†ç¡®ç‡</div>
                        <div style="font-size: 32px; font-weight: 700; color: #48bb78;">${avgAccuracy.toFixed(2)}%</div>
                        <div style="font-size: 13px; color: #666; margin-top: 5px;">${predictions.length} æ¡æ•°æ®</div>
                    `;
                    accuracyGrid.appendChild(overallCard);
                    
                    // æ˜¾ç¤ºå„çº¿è·¯å‡†ç¡®ç‡
                    Object.keys(lineAccuracy).sort().forEach(lineName => {
                        const acc = lineAccuracy[lineName];
                        const avgAcc = acc.sum / acc.count;
                        const card = document.createElement('div');
                        card.className = 'stat-card';
                        card.innerHTML = `
                            <div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">${lineName}</div>
                            <div style="font-size: 24px; font-weight: 700; color: ${avgAcc >= 90 ? '#48bb78' : avgAcc >= 80 ? '#ff9800' : '#f56565'};">${avgAcc.toFixed(2)}%</div>
                            <div style="font-size: 12px; color: #666; margin-top: 3px;">${acc.count} å¤©æ•°æ®</div>
                        `;
                        accuracyGrid.appendChild(card);
                    });
                    
                    accuracyPanel.style.display = 'block';
                }
            }
            
            // æŒ‰çº¿è·¯åˆ†ç»„æ˜¾ç¤ºé¢„æµ‹æ•°æ®
            const lineGroups = {};
            data.predictions.forEach(pred => {
                const lineName = pred['çº¿è·¯åç§°'];
                const lineNo = pred['çº¿è·¯ç¼–å·'];
                if (!lineGroups[lineName]) {
                    lineGroups[lineName] = { lineNo: lineNo, data: [] };
                }
                lineGroups[lineName].data.push(pred);
            });
            
            // æ’åºï¼šçº¿ç½‘(0)ä¼˜å…ˆ
            const sortedLines = Object.keys(lineGroups).sort((a, b) => {
                const aNo = lineGroups[a].lineNo;
                const bNo = lineGroups[b].lineNo;
                if (aNo === 0) return -1;
                if (bNo === 0) return 1;
                return aNo - bNo;
            });
            
            // ä¸ºæ¯æ¡çº¿è·¯åˆ›å»ºå¡ç‰‡
            sortedLines.forEach(lineName => {
                const lineData = lineGroups[lineName].data.sort((a, b) => a['ç¬¬å‡ å¤©'] - b['ç¬¬å‡ å¤©']);
                const lineNo = lineGroups[lineName].lineNo;
                const isNetwork = (lineNo === 0);
                
                // è®¡ç®—å¹³å‡å‡†ç¡®ç‡
                const withAccuracy = lineData.filter(d => d['å‡†ç¡®ç‡'] !== null);
                const avgAccuracy = withAccuracy.length > 0 ? 
                    withAccuracy.reduce((sum, d) => sum + d['å‡†ç¡®ç‡'], 0) / withAccuracy.length : null;
                
                const card = document.createElement('div');
                card.className = `growth-card ${isNetwork ? 'network' : ''}`;
                
                let cardHTML = `
                    <div class="growth-card-header">
                        <div class="growth-line-name">
                            ${isNetwork ? 'ğŸŒ ' : ''}${lineName}${isNetwork ? 'ï¼ˆçº¿ç½‘æ€»ä½“ï¼‰' : ''}
                        </div>
                        ${avgAccuracy !== null ? `
                            <div style="background: ${avgAccuracy >= 90 ? '#48bb78' : avgAccuracy >= 80 ? '#ff9800' : '#f56565'}; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600;">
                                å‡†ç¡®ç‡: ${avgAccuracy.toFixed(2)}%
                            </div>
                        ` : ''}
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">æ—¥æœŸ</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e0e0e0;">åŸºæœŸæ—¥å‡</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e0e0e0;">æœ€ä¼˜å¢é•¿ç‡</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">æ¥æºå¹´ä»½</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e0e0e0;">é¢„æµ‹å®¢æµ</th>
                                ${data.has_actual ? `
                                    <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e0e0e0;">å®é™…å®¢æµ</th>
                                    <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e0e0e0;">è¯¯å·®</th>
                                    <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e0e0e0;">å‡†ç¡®ç‡</th>
                                ` : ''}
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                lineData.forEach(pred => {
                    const growthColor = pred['æœ€ä¼˜å¢é•¿ç‡'] >= 0 ? '#48bb78' : '#f56565';
                    const accuracyColor = pred['å‡†ç¡®ç‡'] >= 90 ? '#48bb78' : pred['å‡†ç¡®ç‡'] >= 80 ? '#ff9800' : '#f56565';
                    
                    cardHTML += `
                        <tr style="border-bottom: 1px solid #f0f0f0;">
                            <td style="padding: 10px; text-align: center; font-weight: 600;">${pred['é¢„æµ‹æ—¥æœŸ']}</td>
                            <td style="padding: 10px; text-align: right;">${pred['åŸºæœŸæ—¥å‡'].toLocaleString('zh-CN')}</td>
                            <td style="padding: 10px; text-align: right; color: ${growthColor}; font-weight: 600;">
                                ${pred['æœ€ä¼˜å¢é•¿ç‡'] >= 0 ? 'â†‘' : 'â†“'} ${Math.abs(pred['æœ€ä¼˜å¢é•¿ç‡']).toFixed(2)}%
                            </td>
                            <td style="padding: 10px; text-align: center; color: #667eea; font-weight: 600;">${pred['æœ€ä¼˜æ¥æºå¹´ä»½']}å¹´</td>
                            <td style="padding: 10px; text-align: right; background: #fff9e6; font-weight: 700; color: #ff9800;">
                                ${pred['é¢„æµ‹å®¢æµ'].toLocaleString('zh-CN')}
                            </td>
                            ${data.has_actual ? `
                                <td style="padding: 10px; text-align: right; font-weight: 600;">
                                    ${pred['å®é™…å®¢æµ'] !== null ? pred['å®é™…å®¢æµ'].toLocaleString('zh-CN') : '-'}
                                </td>
                                <td style="padding: 10px; text-align: right; color: ${pred['è¯¯å·®'] > 0 ? '#f56565' : '#48bb78'}; font-weight: 600;">
                                    ${pred['è¯¯å·®'] !== null ? (pred['è¯¯å·®'] > 0 ? '+' : '') + pred['è¯¯å·®'].toLocaleString('zh-CN') : '-'}
                                </td>
                                <td style="padding: 10px; text-align: right; background: ${pred['å‡†ç¡®ç‡'] >= 90 ? '#e6f7ed' : pred['å‡†ç¡®ç‡'] >= 80 ? '#fff9e6' : '#fee'}; font-weight: 700; color: ${accuracyColor};">
                                    ${pred['å‡†ç¡®ç‡'] !== null ? pred['å‡†ç¡®ç‡'].toFixed(2) + '%' : '-'}
                                </td>
                            ` : ''}
                        </tr>
                    `;
                });
                
                cardHTML += `
                        </tbody>
                    </table>
                `;
                
                card.innerHTML = cardHTML;
                dataContainer.appendChild(card);
            });
            
            resultsPanel.style.display = 'block';
            resultsPanel.scrollIntoView({ behavior: 'smooth' });
        }
        
        // ============ è½¦ç«™é¢„æµ‹åŠŸèƒ½ ============
        
        // è®¾ç½®è½¦ç«™é¢„æµ‹æ—¥æœŸçš„é»˜è®¤å€¼
        const stationPredictStartInput = document.getElementById('stationPredictStartDate');
        const stationPredictEndInput = document.getElementById('stationPredictEndDate');
        if (stationPredictStartInput && stationPredictEndInput) {
            const today = new Date();
            const thisMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            stationPredictStartInput.valueAsDate = thisMonthStart;
            
            const defaultEndDate = new Date(thisMonthStart);
            defaultEndDate.setDate(defaultEndDate.getDate() + 4);
            stationPredictEndInput.valueAsDate = defaultEndDate;
            
            updateStationBasePeriod();
            updateStationMultiYearConfig();
        }
        
        // ç›‘å¬è½¦ç«™é¢„æµ‹å¼€å§‹æ—¥æœŸå˜åŒ–
        document.getElementById('stationPredictStartDate')?.addEventListener('change', function() {
            const startDate = this.valueAsDate;
            if (startDate) {
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 4);
                const endDateInput = document.getElementById('stationPredictEndDate');
                endDateInput.valueAsDate = endDate;
                
                endDateInput.classList.add('auto-filled');
                setTimeout(() => {
                    endDateInput.classList.remove('auto-filled');
                }, 800);
            }
            
            updateStationBasePeriod();
            updateStationMultiYearConfig();
            checkStationDataAvailability();
        });
        
        document.getElementById('stationPredictEndDate')?.addEventListener('change', function() {
            updateStationBasePeriod();
            updateStationMultiYearConfig();
            checkStationDataAvailability();
        });
        
        if (stationPredictStartInput && stationPredictEndInput && stationPredictStartInput.value && stationPredictEndInput.value) {
            checkStationDataAvailability();
        }
        
        function checkStationDataAvailability() {
            const metricType = document.getElementById('stationPredictMetricType').value;
            const startDate = document.getElementById('stationPredictStartDate').value;
            const endDate = document.getElementById('stationPredictEndDate').value;
            
            if (!startDate || !endDate) {
                document.getElementById('stationDataCheck').style.display = 'none';
                return;
            }
            
            const checkDiv = document.getElementById('stationDataCheck');
            const iconDiv = document.getElementById('stationDataCheckIcon');
            const textDiv = document.getElementById('stationDataCheckText');
            
            checkDiv.style.display = 'block';
            checkDiv.style.background = '#f7fafc';
            checkDiv.style.border = '1px solid #e2e8f0';
            iconDiv.textContent = 'â³';
            textDiv.innerHTML = '<span style="color: #666;">æ­£åœ¨æ£€æŸ¥æ•°æ®å¯ç”¨æ€§...</span>';
            
            fetch('/check_station_data_availability', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    metric_type: metricType,
                    start_date: startDate,
                    end_date: endDate
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.has_data) {
                        checkDiv.style.background = '#f0fdf4';
                        checkDiv.style.border = '1px solid #86efac';
                        iconDiv.textContent = 'âœ…';
                        textDiv.innerHTML = `<strong style="color: #16a34a;">${data.message}</strong>`;
                    } else {
                        checkDiv.style.background = '#fff7ed';
                        checkDiv.style.border = '1px solid #fdba74';
                        iconDiv.textContent = 'âš ï¸';
                        textDiv.innerHTML = `<span style="color: #ea580c;">${data.message}</span>`;
                    }
                } else {
                    checkDiv.style.background = '#fef2f2';
                    checkDiv.style.border = '1px solid #fca5a5';
                    iconDiv.textContent = 'âŒ';
                    textDiv.innerHTML = `<span style="color: #dc2626;">æ£€æŸ¥å¤±è´¥ï¼š${data.error}</span>`;
                }
            })
            .catch(error => {
                checkDiv.style.background = '#fef2f2';
                checkDiv.style.border = '1px solid #fca5a5';
                iconDiv.textContent = 'âŒ';
                textDiv.innerHTML = `<span style="color: #dc2626;">æ£€æŸ¥å¤±è´¥ï¼š${error.message}</span>`;
            });
        }
        
        function toggleStationMultiYearConfig() {
            const inputs = document.getElementById('stationMultiYearInputs');
            const icon = document.getElementById('stationMultiYearExpandIcon');
            
            if (inputs.classList.contains('show')) {
                inputs.classList.remove('show');
                icon.classList.remove('expanded');
            } else {
                inputs.classList.add('show');
                icon.classList.add('expanded');
            }
        }
        
        function updateStationMultiYearConfig() {
            const historyYears = parseInt(document.getElementById('stationHistoryYears').value);
            const section = document.getElementById('stationMultiYearSection');
            const container = document.getElementById('stationYearConfigContainer');
            
            if (historyYears === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            container.innerHTML = '';
            
            const predictStart = document.getElementById('stationPredictStartDate').value;
            const predictEnd = document.getElementById('stationPredictEndDate').value;
            
            if (!predictStart || !predictEnd) {
                container.innerHTML = '<div class="metric-info">è¯·å…ˆé€‰æ‹©é¢„æµ‹æ—¥æœŸ</div>';
                return;
            }
            
            const predictYear = new Date(predictStart).getFullYear();
            const predictMonth = new Date(predictStart).getMonth();
            
            for (let i = 1; i <= historyYears; i++) {
                const historyYear = predictYear - i;
                const refStart = predictStart.replace(/^\d{4}/, historyYear);
                const refEnd = predictEnd.replace(/^\d{4}/, historyYear);
                
                let baseMonth = predictMonth - 1;
                let baseYear = historyYear;
                if (baseMonth < 0) {
                    baseMonth = 11;
                    baseYear--;
                }
                
                const baseStart = new Date(baseYear, baseMonth, 1);
                const baseEnd = new Date(baseYear, baseMonth + 1, 0);
                const historyBaseStart = formatDateLocal(baseStart);
                const historyBaseEnd = formatDateLocal(baseEnd);
                
                const yearConfig = document.createElement('div');
                yearConfig.className = 'year-config-item';
                yearConfig.innerHTML = `
                    <div class="year-label">${historyYear}å¹´å‚è€ƒæ•°æ®ï¼ˆå‰${i}å¹´ï¼‰</div>
                    <div class="date-range">
                        <div class="form-group">
                            <label for="stationYear${historyYear}RefStart">å‚è€ƒæœŸå¼€å§‹</label>
                            <input type="date" id="stationYear${historyYear}RefStart" value="${refStart}">
                        </div>
                        <div class="form-group">
                            <label for="stationYear${historyYear}RefEnd">å‚è€ƒæœŸç»“æŸ</label>
                            <input type="date" id="stationYear${historyYear}RefEnd" value="${refEnd}">
                        </div>
                    </div>
                    <div class="date-range" style="margin-top: 10px;">
                        <div class="form-group">
                            <label for="stationYear${historyYear}BaseStart">åŸºæœŸå¼€å§‹</label>
                            <input type="date" id="stationYear${historyYear}BaseStart" value="${historyBaseStart}">
                        </div>
                        <div class="form-group">
                            <label for="stationYear${historyYear}BaseEnd">åŸºæœŸç»“æŸ</label>
                            <input type="date" id="stationYear${historyYear}BaseEnd" value="${historyBaseEnd}">
                        </div>
                    </div>
                `;
                container.appendChild(yearConfig);
            }
        }
        
        function updateStationBasePeriod() {
            const predictStart = document.getElementById('stationPredictStartDate').value;
            const displayElement = document.getElementById('stationBasePeriodDisplay');
            
            if (!predictStart) {
                displayElement.textContent = 'è¯·å…ˆé€‰æ‹©é¢„æµ‹æ—¥æœŸ';
                return;
            }
            
            const predictDate = new Date(predictStart);
            const predictYear = predictDate.getFullYear();
            const predictMonth = predictDate.getMonth();
            
            let baseMonth = predictMonth - 1;
            let baseYear = predictYear;
            if (baseMonth < 0) {
                baseMonth = 11;
                baseYear--;
            }
            
            const baseStart = new Date(baseYear, baseMonth, 1);
            const baseEnd = new Date(baseYear, baseMonth + 1, 0);
            const baseStartDate = formatDateLocal(baseStart);
            const baseEndDate = formatDateLocal(baseEnd);
            const days = baseEnd.getDate();
            
            const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
            displayElement.textContent = `${baseStartDate} è‡³ ${baseEndDate} ï¼ˆ${baseYear}å¹´${monthNames[baseMonth]}ï¼Œå…±${days}å¤©ï¼‰`;
        }
        
        function predictStationFlow() {
            const metricType = document.getElementById('stationPredictMetricType').value;
            const predictStart = document.getElementById('stationPredictStartDate').value;
            const predictEnd = document.getElementById('stationPredictEndDate').value;
            const historyYears = parseInt(document.getElementById('stationHistoryYears').value);
            
            if (!predictStart || !predictEnd) {
                showStationPredictError('è¯·é€‰æ‹©é¢„æµ‹æ—¥æœŸèŒƒå›´');
                return;
            }
            
            if (new Date(predictStart) > new Date(predictEnd)) {
                showStationPredictError('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
                return;
            }
            
            let customConfigs = null;
            const inputs = document.getElementById('stationMultiYearInputs');
            if (inputs && inputs.classList.contains('show')) {
                customConfigs = {};
                const predictYear = new Date(predictStart).getFullYear();
                
                for (let i = 1; i <= historyYears; i++) {
                    const historyYear = predictYear - i;
                    const refStart = document.getElementById(`stationYear${historyYear}RefStart`);
                    const refEnd = document.getElementById(`stationYear${historyYear}RefEnd`);
                    const baseStart = document.getElementById(`stationYear${historyYear}BaseStart`);
                    const baseEnd = document.getElementById(`stationYear${historyYear}BaseEnd`);
                    
                    if (refStart && refEnd && baseStart && baseEnd) {
                        customConfigs[historyYear] = {
                            ref_start: refStart.value,
                            ref_end: refEnd.value,
                            base_start: baseStart.value,
                            base_end: baseEnd.value
                        };
                    }
                }
            }
            
            const predictBtn = document.getElementById('stationPredictBtn');
            const loading = document.getElementById('stationPredictLoading');
            
            predictBtn.disabled = true;
            predictBtn.innerHTML = '<span>â³</span><span>é¢„æµ‹ä¸­...</span>';
            loading.classList.add('show');
            
            const requestData = {
                metric_type: metricType,
                predict_start: predictStart,
                predict_end: predictEnd,
                history_years: historyYears
            };
            
            if (customConfigs && Object.keys(customConfigs).length > 0) {
                requestData.custom_configs = customConfigs;
            }
            
            console.log('å‘é€è½¦ç«™é¢„æµ‹è¯·æ±‚:', requestData);
            
            fetch('/predict_station_flow', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                console.log('æ”¶åˆ°å“åº”:', response.status, response.statusText);
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('å“åº”å†…å®¹:', text);
                        throw new Error(`HTTP ${response.status}: ${text.substring(0, 200)}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('è§£ææˆåŠŸ:', data);
                loading.classList.remove('show');
                predictBtn.disabled = false;
                predictBtn.innerHTML = '<span>ğŸš‰</span><span>å¼€å§‹é¢„æµ‹</span>';
                
                if (data.success) {
                    displayStationPredictResults(data);
                } else {
                    showStationPredictError(data.error || 'é¢„æµ‹å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('è¯·æ±‚å¤±è´¥:', error);
                loading.classList.remove('show');
                predictBtn.disabled = false;
                predictBtn.innerHTML = '<span>ğŸš‰</span><span>å¼€å§‹é¢„æµ‹</span>';
                showStationPredictError('ç½‘ç»œé”™è¯¯: ' + error.message);
            });
        }
        
        function showStationPredictError(message) {
            const errorDiv = document.getElementById('stationPredictErrorMessage');
            errorDiv.textContent = 'âŒ ' + message;
            errorDiv.classList.add('show');
            setTimeout(() => {
                errorDiv.classList.remove('show');
            }, 5000);
        }
        
        function displayStationPredictResults(data) {
            console.log('æ˜¾ç¤ºè½¦ç«™é¢„æµ‹ç»“æœ:', data);
            
            const resultsPanel = document.getElementById('stationPredictResultsPanel');
            const recordCount = document.getElementById('stationPredictRecordCount');
            const accuracyPanel = document.getElementById('stationAccuracyPanel');
            const accuracyGrid = document.getElementById('stationAccuracyGrid');
            const dataContainer = document.getElementById('stationDataContainer');
            
            dataContainer.innerHTML = '';
            accuracyGrid.innerHTML = '';
            
            recordCount.textContent = `${data.predictions.length} æ¡é¢„æµ‹`;
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'metric-info';
            infoDiv.style.marginBottom = '20px';
            infoDiv.innerHTML = `
                é¢„æµ‹æ—¥æœŸï¼š${data.predict_period}<br>
                å‚è€ƒå†å²ï¼šå‰${data.history_years}å¹´åŒæœŸè½¦ç«™æœ€ä¼˜å¢é•¿ç‡
                ${data.has_actual ? '<br><strong style="color: #48bb78;">âœ“ å·²æ‰¾åˆ°å®é™…æ•°æ®ï¼Œå‡†ç¡®ç‡å¯¹æ¯”å¦‚ä¸‹</strong>' : '<br><strong style="color: #ff9800;">âš  æš‚æ— å®é™…æ•°æ®ï¼Œä»…æ˜¾ç¤ºé¢„æµ‹å€¼</strong>'}
            `;
            dataContainer.appendChild(infoDiv);
            
            // æ·»åŠ æŸ¥çœ‹è®¡ç®—è¿‡ç¨‹çš„å±•å¼€åŒºåŸŸ
            if (data.history_details && data.history_details.length > 0) {
                const detailsSection = document.createElement('div');
                detailsSection.className = 'multi-year-section';
                detailsSection.style.marginBottom = '20px';
                
                const detailsHeader = document.createElement('div');
                detailsHeader.className = 'multi-year-header';
                detailsHeader.onclick = function() { toggleStationPredictDetails(); };
                detailsHeader.innerHTML = `
                    <div class="multi-year-title">
                        <span>ğŸ”</span>
                        <span>æŸ¥çœ‹è®¡ç®—è¿‡ç¨‹ï¼ˆå†å¹´è½¦ç«™æ•°æ®è¯¦æƒ…ï¼‰</span>
                    </div>
                    <div class="expand-icon" id="stationDetailsExpandIcon">ğŸ”½</div>
                `;
                detailsSection.appendChild(detailsHeader);
                
                const detailsContent = document.createElement('div');
                detailsContent.className = 'multi-year-inputs';
                detailsContent.id = 'stationDetailsContent';
                
                data.history_details.forEach(yearDetail => {
                    const yearDiv = document.createElement('div');
                    yearDiv.className = 'year-config-item';
                    yearDiv.style.marginBottom = '15px';
                    
                    let html = `
                        <div class="year-label">${yearDetail.year}å¹´å†å²æ•°æ®</div>
                        <div class="metric-info" style="margin: 10px 0;">
                            å‚è€ƒæœŸï¼š${yearDetail.ref_period}<br>
                            åŸºæœŸï¼š${yearDetail.base_period}
                        </div>
                    `;
                    
                    if (yearDetail.line_stats && yearDetail.line_stats.length > 0) {
                        html += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: 13px;">';
                        html += '<thead><tr style="background-color: #f7fafc;">';
                        html += '<th style="padding: 8px; text-align: left; border: 1px solid #e2e8f0;">è½¦ç«™</th>';
                        html += '<th style="padding: 8px; text-align: right; border: 1px solid #e2e8f0;">åŸºæœŸæ—¥å‡</th>';
                        html += '<th style="padding: 8px; text-align: right; border: 1px solid #e2e8f0;">å¹³å‡å¢é•¿ç‡</th>';
                        html += '<th style="padding: 8px; text-align: right; border: 1px solid #e2e8f0;">æœ€å¤§å¢é•¿ç‡</th>';
                        html += '</tr></thead><tbody>';
                        
                        yearDetail.line_stats.forEach(stat => {
                            const avgColor = stat.avg_growth >= 0 ? '#48bb78' : '#f56565';
                            const maxColor = stat.max_growth >= 0 ? '#48bb78' : '#f56565';
                            html += `<tr>
                                <td style="padding: 8px; border: 1px solid #e2e8f0;">${stat.line_name}</td>
                                <td style="padding: 8px; text-align: right; border: 1px solid #e2e8f0;">${stat.base_avg.toLocaleString()}</td>
                                <td style="padding: 8px; text-align: right; border: 1px solid #e2e8f0; color: ${avgColor}; font-weight: 600;">${stat.avg_growth.toFixed(2)}%</td>
                                <td style="padding: 8px; text-align: right; border: 1px solid #e2e8f0; color: ${maxColor}; font-weight: 600;">${stat.max_growth.toFixed(2)}%</td>
                            </tr>`;
                        });
                        
                        html += '</tbody></table></div>';
                    }
                    
                    yearDiv.innerHTML = html;
                    detailsContent.appendChild(yearDiv);
                });
                
                detailsSection.appendChild(detailsContent);
                dataContainer.appendChild(detailsSection);
            }
            
            // å‡†ç¡®ç‡ç»Ÿè®¡
            if (data.has_actual) {
                const predictions = data.predictions.filter(p => p['å‡†ç¡®ç‡'] !== null);
                if (predictions.length > 0) {
                    const avgAccuracy = predictions.reduce((sum, p) => sum + p['å‡†ç¡®ç‡'], 0) / predictions.length;
                    
                    const stationAccuracy = {};
                    predictions.forEach(p => {
                        const stationName = p['è½¦ç«™åç§°'];
                        if (!stationAccuracy[stationName]) {
                            stationAccuracy[stationName] = { sum: 0, count: 0 };
                        }
                        stationAccuracy[stationName].sum += p['å‡†ç¡®ç‡'];
                        stationAccuracy[stationName].count++;
                    });
                    
                    const overallCard = document.createElement('div');
                    overallCard.className = 'stat-card';
                    overallCard.style.borderLeftColor = '#48bb78';
                    overallCard.innerHTML = `
                        <div style="font-weight: 600; color: #48bb78; margin-bottom: 8px; font-size: 16px;">æ€»ä½“å¹³å‡å‡†ç¡®ç‡</div>
                        <div style="font-size: 32px; font-weight: 700; color: #48bb78;">${avgAccuracy.toFixed(2)}%</div>
                        <div style="font-size: 13px; color: #666; margin-top: 5px;">${predictions.length} æ¡æ•°æ®</div>
                    `;
                    accuracyGrid.appendChild(overallCard);
                    
                    Object.keys(stationAccuracy).sort().forEach(stationName => {
                        const acc = stationAccuracy[stationName];
                        const avgAcc = acc.sum / acc.count;
                        const card = document.createElement('div');
                        card.className = 'stat-card';
                        card.innerHTML = `
                            <div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">${stationName}</div>
                            <div style="font-size: 24px; font-weight: 700; color: ${avgAcc >= 90 ? '#48bb78' : avgAcc >= 80 ? '#ff9800' : '#f56565'};">${avgAcc.toFixed(2)}%</div>
                            <div style="font-size: 12px; color: #666; margin-top: 3px;">${acc.count} å¤©æ•°æ®</div>
                        `;
                        accuracyGrid.appendChild(card);
                    });
                    
                    accuracyPanel.style.display = 'block';
                }
            }
            
            // æŒ‰è½¦ç«™åˆ†ç»„æ˜¾ç¤ºé¢„æµ‹ç»“æœ
            const stationGroups = {};
            data.predictions.forEach(pred => {
                const stationName = pred['è½¦ç«™åç§°'];
                if (!stationGroups[stationName]) {
                    stationGroups[stationName] = [];
                }
                stationGroups[stationName].push(pred);
            });
            
            const sortedStations = Object.keys(stationGroups).sort();
            
            sortedStations.forEach(stationName => {
                const card = document.createElement('div');
                card.className = 'line-card';
                card.style.marginBottom = '20px';
                
                const stationPreds = stationGroups[stationName];
                let cardHTML = `
                    <div class="line-card-header">
                        <h3>${stationName}</h3>
                    </div>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background-color: #f7fafc;">
                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">æ—¥æœŸ</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e0e0e0;">åŸºæœŸæ—¥å‡</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e0e0e0;">æœ€ä¼˜å¢é•¿ç‡</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e0e0e0;">æ¥æºå¹´ä»½</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e0e0e0;">é¢„æµ‹å®¢æµ</th>
                                ${data.has_actual ? `
                                    <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e0e0e0;">å®é™…å®¢æµ</th>
                                    <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e0e0e0;">è¯¯å·®</th>
                                    <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e0e0e0;">å‡†ç¡®ç‡</th>
                                ` : ''}
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                stationPreds.forEach(pred => {
                    const growthColor = pred['æœ€ä¼˜å¢é•¿ç‡'] >= 0 ? '#48bb78' : '#f56565';
                    const accuracyColor = pred['å‡†ç¡®ç‡'] >= 90 ? '#48bb78' : pred['å‡†ç¡®ç‡'] >= 80 ? '#ff9800' : '#f56565';
                    
                    const dateStr = pred['é¢„æµ‹æ—¥æœŸ'];
                    const formattedDate = `${dateStr.substring(0, 4)}-${dateStr.substring(4, 6)}-${dateStr.substring(6, 8)}`;
                    
                    cardHTML += `
                        <tr style="border-bottom: 1px solid #f0f0f0;">
                            <td style="padding: 10px; text-align: center; font-weight: 600;">${formattedDate}</td>
                            <td style="padding: 10px; text-align: right;">
                                ${pred['åŸºæœŸæ—¥å‡'].toLocaleString('zh-CN')}
                            </td>
                            <td style="padding: 10px; text-align: right; color: ${growthColor}; font-weight: 700;">
                                ${pred['æœ€ä¼˜å¢é•¿ç‡'] > 0 ? '+' : ''}${pred['æœ€ä¼˜å¢é•¿ç‡'].toFixed(2)}%
                            </td>
                            <td style="padding: 10px; text-align: center; color: #667eea; font-weight: 600;">${pred['æœ€ä¼˜æ¥æºå¹´ä»½']}å¹´</td>
                            <td style="padding: 10px; text-align: right; background: #fff9e6; font-weight: 700; color: #ff9800;">
                                ${pred['é¢„æµ‹å®¢æµ'].toLocaleString('zh-CN')}
                            </td>
                            ${data.has_actual ? `
                                <td style="padding: 10px; text-align: right; font-weight: 600;">
                                    ${pred['å®é™…å®¢æµ'] !== null ? pred['å®é™…å®¢æµ'].toLocaleString('zh-CN') : '-'}
                                </td>
                                <td style="padding: 10px; text-align: right; color: ${pred['è¯¯å·®'] > 0 ? '#f56565' : '#48bb78'}; font-weight: 600;">
                                    ${pred['è¯¯å·®'] !== null ? (pred['è¯¯å·®'] > 0 ? '+' : '') + pred['è¯¯å·®'].toLocaleString('zh-CN') : '-'}
                                </td>
                                <td style="padding: 10px; text-align: right; background: ${pred['å‡†ç¡®ç‡'] >= 90 ? '#e6f7ed' : pred['å‡†ç¡®ç‡'] >= 80 ? '#fff9e6' : '#fee'}; font-weight: 700; color: ${accuracyColor};">
                                    ${pred['å‡†ç¡®ç‡'] !== null ? pred['å‡†ç¡®ç‡'].toFixed(2) + '%' : '-'}
                                </td>
                            ` : ''}
                        </tr>
                    `;
                });
                
                cardHTML += `
                        </tbody>
                    </table>
                `;
                
                card.innerHTML = cardHTML;
                dataContainer.appendChild(card);
            });
            
            resultsPanel.style.display = 'block';
            resultsPanel.scrollIntoView({ behavior: 'smooth' });
        }
        
        function toggleStationPredictDetails() {
            const content = document.getElementById('stationDetailsContent');
            const icon = document.getElementById('stationDetailsExpandIcon');
            
            if (content && icon) {
                if (content.classList.contains('show')) {
                    content.classList.remove('show');
                    icon.classList.remove('expanded');
                } else {
                    content.classList.add('show');
                    icon.classList.add('expanded');
                }
            }
        }
    </script>
</body>
</html>


