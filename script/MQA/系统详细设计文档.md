# 地铁客流智能问数系统详细设计文档

## 1. 项目概述

### 1.1 项目背景
地铁客流智能问数系统是一个基于自然语言处理（NLP）的智能数据查询系统，允许用户通过自然语言提问的方式查询地铁客流相关数据，包括历史客流、预测客流、车站客流、线路客流等信息。

### 1.2 项目目标
- 提供自然语言查询接口，用户可以用中文提问查询地铁客流数据
- 支持历史数据查询和预测数据查询
- 支持多维度查询：按线路、车站、日期、时间等
- 提供友好的Web界面和API接口
- 支持数据可视化展示

### 1.3 核心功能
1. **自然语言理解（NLU）**：理解用户的中文查询意图
2. **SQL生成（NL2SQL）**：将自然语言转换为SQL查询语句
3. **数据查询执行**：执行SQL查询并返回结果
4. **结果展示**：以表格、图表等形式展示查询结果
5. **查询历史**：保存用户查询历史，支持查询回放

## 2. 系统架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                     前端展示层                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  Web界面     │  │  移动端H5    │  │  API客户端   │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                          │
                          │ HTTP/WebSocket
                          ▼
┌─────────────────────────────────────────────────────────┐
│                      API服务层                           │
│  ┌──────────────────────────────────────────────────┐   │
│  │         FastAPI RESTful API                     │   │
│  │  - /api/query          (自然语言查询)            │   │
│  │  - /api/sql            (SQL直接查询)             │   │
│  │  - /api/history        (查询历史)                │   │
│  │  - /api/suggestions    (查询建议)                │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                     业务逻辑层                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ NL2SQL引擎   │  │ 查询执行器   │  │ 结果处理器   │  │
│  │              │  │              │  │              │  │
│  │ - 意图识别   │  │ - SQL验证    │  │ - 数据格式化 │  │
│  │ - 实体抽取   │  │ - 执行查询   │  │ - 图表生成   │  │
│  │ - SQL生成    │  │ - 异常处理   │  │ - 导出功能   │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                     数据访问层                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ 数据库连接池 │  │ 缓存层(Redis)│  │ 元数据管理   │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                     数据存储层                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ master数据库 │  │CxFlowPredict │  │  Redis缓存   │  │
│  │ (历史数据)   │  │ (预测数据)   │  │  (查询缓存)  │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 2.2 技术栈选型

#### 后端技术栈
- **Web框架**: FastAPI (高性能、自动API文档)
- **数据库驱动**: pymssql (SQL Server连接)
- **NLP框架**: 
  - 方案1: 基于规则 + 模板匹配（快速实现）
  - 方案2: 使用大语言模型API (如OpenAI GPT、百度文心、阿里通义等)
  - 方案3: 使用开源NL2SQL模型 (如ChatGLM、Qwen等)
- **缓存**: Redis (查询结果缓存、会话管理)
- **任务队列**: Celery (异步任务处理，可选)
- **日志**: Python logging + ELK (可选)

#### 前端技术栈
- **框架**: Vue 3 + TypeScript
- **UI组件库**: Element Plus / Ant Design Vue
- **图表库**: ECharts / Chart.js
- **HTTP客户端**: Axios
- **状态管理**: Pinia
- **构建工具**: Vite

#### 部署技术栈
- **容器化**: Docker + Docker Compose
- **Web服务器**: Nginx (反向代理、静态资源)
- **进程管理**: Supervisor / systemd
- **监控**: Prometheus + Grafana (可选)

## 3. 核心模块设计

### 3.1 NL2SQL引擎模块

#### 3.1.1 功能概述
将自然语言查询转换为SQL语句，是整个系统的核心模块。

#### 3.1.2 设计思路

**方案A: 基于规则和模板匹配（推荐用于快速实现）**
- 优点：实现快速、可控性强、无需训练数据
- 缺点：需要维护大量规则，扩展性较差

**方案B: 基于大语言模型（推荐用于生产环境）**
- 优点：理解能力强、扩展性好、支持复杂查询
- 缺点：需要API调用成本、响应时间可能较长

**方案C: 混合方案（推荐）**
- 简单查询使用规则匹配
- 复杂查询使用LLM
- 提供SQL模板库

#### 3.1.3 模块结构

```
nl2sql/
├── __init__.py
├── intent_classifier.py      # 意图分类器
├── entity_extractor.py       # 实体抽取器
├── sql_generator.py          # SQL生成器
├── rule_based_engine.py      # 基于规则的引擎
├── llm_based_engine.py       # 基于LLM的引擎
├── sql_validator.py          # SQL验证器
└── templates/                # SQL模板库
    ├── line_flow_templates.py
    ├── station_flow_templates.py
    └── prediction_templates.py
```

#### 3.1.4 意图分类

系统需要识别的查询意图类型：

1. **线路客流查询**
   - 示例："查询1号线昨天的客流量"
   - 示例："2号线本周的平均客流量是多少"

2. **车站客流查询**
   - 示例："五一广场站今天的进站量"
   - 示例："查询所有车站的客流量排名"

3. **时间维度查询**
   - 示例："查询最近7天的客流趋势"
   - 示例："今年国庆节的客流量"

4. **预测数据查询**
   - 示例："预测明天1号线的客流量"
   - 示例："未来一周的客流预测"

5. **对比分析查询**
   - 示例："对比1号线和2号线的客流量"
   - 示例："本周与上周的客流对比"

6. **统计分析查询**
   - 示例："客流量最高的10个车站"
   - 示例："各线路的平均客流量"

#### 3.1.5 实体抽取

需要抽取的实体类型：

- **线路实体**: "1号线"、"2号线"、"一号线"、"二号线"
- **车站实体**: "五一广场"、"长沙火车站"、"五一广场站"
- **时间实体**: "昨天"、"今天"、"本周"、"2024-01-01"
- **指标实体**: "客流量"、"进站量"、"出站量"、"换乘量"、"乘降量"
- **操作实体**: "查询"、"统计"、"对比"、"预测"、"排名"

#### 3.1.6 SQL模板示例

```python
# 线路日客流查询模板
LINE_DAILY_FLOW_TEMPLATE = """
SELECT 
    f_date,
    f_linename,
    f_klcount as 客流量,
    entry_num as 进站量,
    exit_num as 出站量,
    change_num as 换乘量,
    flow_num as 乘降量
FROM dbo.LineDailyFlowHistory
WHERE 1=1
    {line_condition}
    {date_condition}
ORDER BY f_date DESC
"""

# 车站客流查询模板
STATION_FLOW_TEMPLATE = """
SELECT 
    SQUAD_DATE as 日期,
    STATION_NAME as 车站名,
    ENTRY_NUM as 进站量,
    EXIT_NUM as 出站量,
    CHANGE_NUM as 换乘量,
    PASSENGER_NUM as 客运量,
    FLOW_NUM as 乘降量
FROM dbo.STATION_FLOW_HISTORY
WHERE 1=1
    {station_condition}
    {date_condition}
ORDER BY SQUAD_DATE DESC
"""
```

### 3.2 查询执行器模块

#### 3.2.1 功能概述
负责执行SQL查询，处理数据库连接、查询优化、异常处理等。

#### 3.2.2 模块结构

```
query_executor/
├── __init__.py
├── db_manager.py           # 数据库连接管理
├── query_executor.py       # 查询执行器
├── query_optimizer.py     # 查询优化器
├── result_formatter.py    # 结果格式化
└── connection_pool.py     # 连接池管理
```

#### 3.2.3 核心功能

1. **连接池管理**
   - 维护多个数据库连接池（master、CxFlowPredict）
   - 连接复用、自动重连
   - 连接健康检查

2. **SQL安全验证**
   - 防止SQL注入
   - 限制查询范围（如最多返回10000条）
   - 禁止DROP、DELETE、UPDATE等危险操作

3. **查询优化**
   - 自动添加索引提示
   - 查询结果缓存
   - 分页查询优化

4. **异常处理**
   - 数据库连接异常
   - SQL语法错误
   - 超时处理

### 3.3 结果处理模块

#### 3.3.1 功能概述
处理查询结果，包括数据格式化、图表生成、数据导出等。

#### 3.3.2 模块结构

```
result_processor/
├── __init__.py
├── formatter.py           # 数据格式化
├── chart_generator.py     # 图表生成
├── exporter.py            # 数据导出
└── aggregator.py          # 数据聚合
```

#### 3.3.3 核心功能

1. **数据格式化**
   - 日期格式转换
   - 数值格式化（保留小数位）
   - 中文列名映射

2. **图表生成**
   - 折线图（趋势分析）
   - 柱状图（对比分析）
   - 饼图（占比分析）
   - 热力图（时间分布）

3. **数据导出**
   - Excel导出
   - CSV导出
   - PDF报告生成

### 3.4 元数据管理模块

#### 3.4.1 功能概述
管理数据库表结构、字段信息、业务规则等元数据。

#### 3.4.2 模块结构

```
metadata/
├── __init__.py
├── schema_manager.py      # 表结构管理
├── entity_mapping.py      # 实体映射（车站名、线路名）
└── business_rules.py       # 业务规则
```

#### 3.4.3 核心功能

1. **表结构管理**
   - 自动读取数据库表结构
   - 字段类型映射
   - 字段注释管理

2. **实体映射**
   - 车站名称映射（中文名 -> LINE_ID + STATION_ID）
   - 线路名称映射（中文名 -> LINE_ID）
   - 时间表达式解析（"昨天" -> 具体日期）

## 4. API设计

### 4.1 API接口列表

#### 4.1.1 自然语言查询接口

**POST /api/v1/query**

请求体：
```json
{
  "question": "查询1号线昨天的客流量",
  "options": {
    "use_cache": true,
    "format": "json",
    "max_rows": 1000
  }
}
```

响应体：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "sql": "SELECT f_date, f_linename, f_klcount FROM ...",
    "result": [
      {
        "日期": "20240101",
        "线路名": "1号线",
        "客流量": 123456.78
      }
    ],
    "chart_config": {
      "type": "line",
      "data": {...}
    },
    "execution_time": 0.123
  },
  "metadata": {
    "intent": "line_flow_query",
    "entities": {
      "line": "1号线",
      "date": "2024-01-01"
    }
  }
}
```

#### 4.1.2 SQL直接查询接口

**POST /api/v1/sql**

请求体：
```json
{
  "sql": "SELECT * FROM LineDailyFlowHistory WHERE f_date = 20240101",
  "database": "master"
}
```

#### 4.1.3 查询历史接口

**GET /api/v1/history**

查询参数：
- page: 页码
- page_size: 每页数量
- start_date: 开始日期
- end_date: 结束日期

#### 4.1.4 查询建议接口

**GET /api/v1/suggestions**

返回常用查询模板和建议。

#### 4.1.5 元数据接口

**GET /api/v1/metadata/tables**
**GET /api/v1/metadata/columns/{table_name}**
**GET /api/v1/metadata/stations**
**GET /api/v1/metadata/lines**

### 4.2 WebSocket接口（可选）

用于实时查询和流式返回结果：

**WS /ws/query**

## 5. 数据库设计

### 5.1 系统表设计

#### 5.1.1 查询历史表

```sql
CREATE TABLE query_history (
    id VARCHAR(50) PRIMARY KEY,
    user_id VARCHAR(50),
    question TEXT,
    sql_query TEXT,
    intent VARCHAR(50),
    entities JSON,
    result_count INT,
    execution_time FLOAT,
    status VARCHAR(20),  -- success, error, timeout
    error_message TEXT,
    created_at DATETIME,
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at)
);
```

#### 5.1.2 用户表（可选）

```sql
CREATE TABLE users (
    id VARCHAR(50) PRIMARY KEY,
    username VARCHAR(50) UNIQUE,
    password_hash VARCHAR(255),
    role VARCHAR(20),  -- admin, user, guest
    created_at DATETIME
);
```

#### 5.1.3 查询模板表

```sql
CREATE TABLE query_templates (
    id VARCHAR(50) PRIMARY KEY,
    name VARCHAR(100),
    question_template TEXT,
    sql_template TEXT,
    intent VARCHAR(50),
    category VARCHAR(50),
    usage_count INT,
    created_at DATETIME
);
```

### 5.2 缓存策略

使用Redis缓存：
- 查询结果缓存（key: query_hash, TTL: 1小时）
- 元数据缓存（key: metadata:*, TTL: 24小时）
- 会话缓存（key: session:*, TTL: 30分钟）

## 6. 前端设计

### 6.1 页面结构

```
frontend/
├── src/
│   ├── views/
│   │   ├── QueryPage.vue          # 主查询页面
│   │   ├── HistoryPage.vue         # 查询历史页面
│   │   ├── DashboardPage.vue       # 数据看板页面
│   │   └── SettingsPage.vue        # 设置页面
│   ├── components/
│   │   ├── QueryInput.vue          # 查询输入框
│   │   ├── ResultTable.vue         # 结果表格
│   │   ├── ResultChart.vue         # 结果图表
│   │   ├── QueryHistory.vue        # 查询历史组件
│   │   └── Suggestions.vue         # 查询建议组件
│   ├── api/
│   │   └── query.js                # API调用
│   └── utils/
│       ├── date.js                 # 日期工具
│       └── formatter.js            # 格式化工具
```

### 6.2 主查询页面设计

**功能模块：**
1. **查询输入区**
   - 自然语言输入框
   - 语音输入（可选）
   - 查询建议下拉
   - 快捷查询按钮

2. **结果展示区**
   - 数据表格（可排序、筛选、分页）
   - 图表展示（自动选择合适图表类型）
   - 数据统计信息
   - 导出按钮

3. **侧边栏**
   - 查询历史
   - 常用查询
   - 数据字典

### 6.3 UI/UX设计要点

- 响应式设计，支持PC和移动端
- 深色模式支持
- 加载状态提示
- 错误信息友好提示
- 查询结果高亮显示
- 支持快捷键操作

## 7. 安全设计

### 7.1 SQL注入防护
- 使用参数化查询
- SQL白名单验证
- 禁止危险SQL关键字

### 7.2 访问控制
- API密钥认证
- 用户权限管理
- 查询频率限制

### 7.3 数据安全
- 敏感数据脱敏
- 查询日志记录
- 数据访问审计

## 8. 性能优化

### 8.1 查询优化
- 数据库索引优化
- 查询结果缓存
- 分页查询
- 异步查询（大查询）

### 8.2 系统优化
- 连接池优化
- 异步处理
- CDN加速（静态资源）
- 数据库读写分离（可选）

## 9. 部署方案

### 9.1 Docker部署

**docker-compose.yml:**
```yaml
version: '3.8'

services:
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DB_HOST=10.1.6.230
      - DB_PORT=1433
      - REDIS_HOST=redis
    depends_on:
      - redis

  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
```

### 9.2 部署步骤

1. 环境准备
   - 安装Docker和Docker Compose
   - 配置数据库连接信息

2. 构建镜像
   ```bash
   docker-compose build
   ```

3. 启动服务
   ```bash
   docker-compose up -d
   ```

4. 健康检查
   - 访问 http://localhost/api/health
   - 检查日志输出

## 10. 测试方案

### 10.1 单元测试
- NL2SQL引擎测试
- 查询执行器测试
- 结果处理测试

### 10.2 集成测试
- API接口测试
- 端到端测试

### 10.3 性能测试
- 并发查询测试
- 响应时间测试
- 压力测试

## 11. 监控和日志

### 11.1 日志记录
- 查询日志
- 错误日志
- 性能日志
- 访问日志

### 11.2 监控指标
- API响应时间
- 查询成功率
- 数据库连接数
- 系统资源使用率

## 12. 开发计划

### 12.1 第一阶段（MVP，2-3周）
- [ ] 基础架构搭建
- [ ] 基于规则的NL2SQL引擎
- [ ] 基础API接口
- [ ] 简单前端页面
- [ ] 数据库连接和查询

### 12.2 第二阶段（功能完善，2-3周）
- [ ] 集成LLM引擎
- [ ] 查询历史功能
- [ ] 图表展示
- [ ] 数据导出
- [ ] 前端优化

### 12.3 第三阶段（优化和扩展，2-3周）
- [ ] 性能优化
- [ ] 安全加固
- [ ] 监控和日志
- [ ] 文档完善
- [ ] 测试覆盖

## 13. 附录

### 13.1 常用查询示例

1. "查询1号线昨天的客流量"
2. "五一广场站今天的进站量和出站量"
3. "查询最近7天各线路的客流量趋势"
4. "预测明天1号线的客流量"
5. "客流量最高的10个车站"
6. "对比1号线和2号线本周的客流量"
7. "查询今年国庆节期间的客流数据"
8. "各线路的平均客流量排名"

### 13.2 技术难点和解决方案

1. **自然语言理解准确性**
   - 方案：使用LLM + 规则混合方案
   - 建立查询模板库
   - 持续优化和训练

2. **SQL生成正确性**
   - 方案：SQL验证和测试
   - 提供SQL预览功能
   - 错误反馈机制

3. **查询性能**
   - 方案：查询缓存
   - 数据库索引优化
   - 异步查询处理

### 13.3 参考资料

- FastAPI文档: https://fastapi.tiangolo.com/
- SQL Server文档: https://docs.microsoft.com/sql
- Vue 3文档: https://vuejs.org/
- ECharts文档: https://echarts.apache.org/

